<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BARBERPRO • Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: '#00ff41',
            cyber: {
              green: '#00ff41',
              cyan: '#00d4ff',
              magenta: '#ff00ff'
            },
            dark: {
              900: '#0a0e27',
              800: '#001428',
              700: '#0a1a2a',
              600: '#122030'
            }
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body { 
      background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%); 
      color: #e0e0e0; 
      font-family: system-ui, -apple-system, sans-serif;
    }
    #dashboardMain { display: flex; background: transparent; }
    #loginOverlay { display: none; }

    /* === HACKER LOGIN STYLES === */
    .hacker-login-overlay {
      background: linear-gradient(135deg, #0A0F1C 0%, #1A1F2C 100%);
      font-family: 'VT323', monospace;
    }
    
    .hacker-login-container {
      background: rgba(10, 15, 28, 0.95);
      border: 2px solid transparent;
      border-image: linear-gradient(135deg, #00F5D4, #9D4EDD, #FF6D00) 1;
      box-shadow: 0 0 40px rgba(0, 245, 212, 0.3), 
                  0 0 60px rgba(157, 78, 221, 0.2),
                  inset 0 0 30px rgba(0, 245, 212, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .hacker-login-container::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #00F5D4, #9D4EDD, #FF6D00, #00F5D4);
      background-size: 400% 400%;
      animation: border-glow 3s ease infinite;
      z-index: -1;
      opacity: 0.5;
      filter: blur(12px);
    }
    
    @keyframes border-glow {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .glitch-title {
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(135deg, #00F5D4, #9D4EDD, #FF6D00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: none;
      letter-spacing: 4px;
      position: relative;
      animation: glitch-text 1s infinite;
    }
    
    .glitch-title::before,
    .glitch-title::after {
      content: attr(data-text);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #00F5D4, #9D4EDD, #FF6D00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .glitch-title::before {
      animation: glitch-before 0.3s infinite;
      clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
      filter: hue-rotate(45deg);
    }
    
    .glitch-title::after {
      animation: glitch-after 0.3s infinite reverse;
      clip-path: polygon(0 55%, 100% 55%, 100% 100%, 0 100%);
      filter: hue-rotate(-45deg);
    }
    
    @keyframes glitch-text {
      0%, 90%, 100% { transform: translate(0); }
      20% { transform: translate(-2px, 2px); }
      40% { transform: translate(-2px, -2px); }
      60% { transform: translate(2px, 2px); }
      80% { transform: translate(2px, -2px); }
    }
    
    @keyframes glitch-before {
      0%, 100% { transform: translate(0); }
      33% { transform: translate(-2px, 0); }
      66% { transform: translate(2px, 0); }
    }
    
    @keyframes glitch-after {
      0%, 100% { transform: translate(0); }
      33% { transform: translate(2px, 0); }
      66% { transform: translate(-2px, 0); }
    }
    
    .typewriter-label {
      background: linear-gradient(135deg, #00F5D4, #9D4EDD, #FF6D00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 18px;
      letter-spacing: 2px;
      display: inline-block;
      position: relative;
    }
    
    .typewriter-label.finished-typing::after {
      content: '_';
      display: inline-block;
      animation: blink-caret 0.75s step-end infinite;
      margin-left: 3px;
      background: linear-gradient(135deg, #00F5D4, #9D4EDD, #FF6D00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    @keyframes blink-caret {
      from, to { opacity: 0; }
      50% { opacity: 1; }
    }
    
    .hacker-input {
      background: rgba(0, 245, 212, 0.05);
      border: 1px solid #00F5D4;
      color: #00F5D4;
      padding: 12px 16px;
      font-family: 'VT323', monospace;
      font-size: 20px;
      letter-spacing: 2px;
      transition: all 0.3s ease;
      box-shadow: inset 0 0 10px rgba(0, 245, 212, 0.2);
    }
    
    .hacker-input:focus {
      outline: none;
      border-color: #9D4EDD;
      box-shadow: 0 0 20px rgba(157, 78, 221, 0.5), inset 0 0 15px rgba(157, 78, 221, 0.3);
      background: rgba(157, 78, 221, 0.1);
    }
    
    .hacker-input::placeholder {
      color: rgba(0, 245, 212, 0.4);
    }
    
    .hacker-btn {
      background: linear-gradient(135deg, #00F5D4 0%, #9D4EDD 50%, #FF6D00 100%);
      border: 2px solid transparent;
      color: #0A0F1C;
      font-family: 'VT323', monospace;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 3px;
      padding: 14px 30px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    }
    
    .hacker-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.3);
      transition: left 0.3s ease;
    }
    
    .hacker-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(0, 245, 212, 0.6), 
                  0 0 40px rgba(157, 78, 221, 0.4),
                  0 5px 15px rgba(0, 0, 0, 0.4);
      filter: brightness(1.2);
    }
    
    .hacker-btn:hover::before {
      left: 100%;
    }
    
    .hacker-btn:active {
      transform: translateY(0);
    }
    
    .hacker-footer {
      background: linear-gradient(135deg, #00F5D4, #9D4EDD, #FF6D00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 14px;
      letter-spacing: 1px;
      opacity: 0.7;
      text-align: center;
      margin-top: 20px;
    }
    
    .scan-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #00F5D4, #9D4EDD, #FF6D00, transparent);
      animation: scan 3s linear infinite;
      pointer-events: none;
    }
    
    @keyframes scan {
      0% { top: 0; }
      100% { top: 100%; }
    }
    
    .matrix-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      pointer-events: none;
      opacity: 0.15;
      z-index: 0;
    }
    
    .matrix-char {
      position: absolute;
      font-family: 'VT323', monospace;
      font-size: 20px;
      animation: matrix-fall linear infinite;
      background: linear-gradient(180deg, #00F5D4, #9D4EDD, #FF6D00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    @keyframes matrix-fall {
      0% { transform: translateY(-100%); opacity: 1; }
      100% { transform: translateY(100vh); opacity: 0; }
    }

    /* === DASHBOARD CYBERPUNK THEME (LEGÍVEL) === */
    #dashboardMain {
      background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
      box-shadow: inset 0 0 50px rgba(0, 255, 65, 0.05);
    }

    aside {
      background: rgba(15, 20, 30, 0.95) !important;
      border-right: 1px solid rgba(0, 255, 65, 0.3) !important;
      box-shadow: 0 0 10px rgba(0, 255, 65, 0.1);
    }

    aside .text-white {
      color: #e0e0e0 !important;
      text-shadow: none;
    }

    aside button {
      color: #b0b0b0 !important;
      font-family: system-ui, -apple-system, sans-serif !important;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
    }

    aside button:hover {
      background: rgba(0, 255, 65, 0.1) !important;
      color: #00ff41 !important;
      border-left: 2px solid #00ff41;
    }

    aside button.active {
      background: rgba(0, 255, 65, 0.15) !important;
      color: #00ff41 !important;
      border-left: 3px solid #00ff41;
    }

    /* Header/Topbar */
    header {
      background: rgba(20, 25, 35, 0.95) !important;
      border-bottom: 1px solid rgba(0, 255, 65, 0.2) !important;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    /* Cards */
    .bg-\[\#2A2A2A\],
    [class*="bg-gray"] {
      background: rgba(25, 30, 40, 0.9) !important;
      border: 1px solid rgba(0, 255, 65, 0.2) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(0, 255, 65, 0.05) !important;
    }

    /* Inputs e Selects */
    input,
    select,
    textarea {
      background: rgba(30, 35, 45, 0.8) !important;
      border: 1px solid rgba(0, 255, 65, 0.3) !important;
      color: #e0e0e0 !important;
      font-family: system-ui, -apple-system, sans-serif !important;
      font-size: 14px !important;
      letter-spacing: 0.3px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #00ff41 !important;
      box-shadow: 0 0 0 3px rgba(0, 255, 65, 0.1) !important;
      background: rgba(30, 35, 45, 1) !important;
    }

    input::placeholder {
      color: rgba(176, 176, 176, 0.6) !important;
    }

    /* Botões Primários */
    button:not(.hacker-btn) {
      font-family: system-ui, -apple-system, sans-serif !important;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
    }

    button[class*="bg-emerald"],
    button[class*="bg-green"],
    .btn-primary {
      background: linear-gradient(135deg, #00cc33 0%, #00aa66 100%) !important;
      border: 1px solid rgba(0, 255, 65, 0.4) !important;
      color: #fff !important;
      font-weight: 600 !important;
      text-shadow: none !important;
    }

    button[class*="bg-emerald"]:hover,
    button[class*="bg-green"]:hover {
      background: linear-gradient(135deg, #00ff41 0%, #00cc33 100%) !important;
      box-shadow: 0 4px 12px rgba(0, 255, 65, 0.3) !important;
      transform: translateY(-1px);
    }

    /* Botões Secundários/Danger */
    button[class*="bg-red"],
    button[class*="border-red"] {
      background: transparent !important;
      border: 1px solid rgba(231, 76, 60, 0.6) !important;
      color: #e74c3c !important;
      cursor: pointer !important;
      pointer-events: auto !important;
    }

    button[class*="bg-red"]:hover,
    button[class*="border-red"]:hover {
      background: rgba(231, 76, 60, 0.1) !important;
      border-color: #e74c3c !important;
    }
    
    /* Garantir que botões de ação sejam clicáveis */
    .barber-action-btn,
    .service-action-btn {
      cursor: pointer !important;
      pointer-events: auto !important;
      user-select: none !important;
    }
    
    /* Garantir que conteúdo dos botões (emojis) não bloqueie cliques */
    .barber-action-btn *,
    .service-action-btn * {
      pointer-events: none !important;
    }

    /* Badges de Status */
    .badge,
    span[class*="bg-green"],
    span[class*="bg-yellow"],
    span[class*="bg-red"] {
      font-family: system-ui, -apple-system, sans-serif !important;
      letter-spacing: 0.3px;
      font-size: 12px !important;
      font-weight: 600 !important;
    }

    /* Tabelas */
    table {
      border: 1px solid rgba(0, 255, 65, 0.2) !important;
    }

    th {
      background: rgba(0, 255, 65, 0.05) !important;
      color: #00ff41 !important;
      font-family: system-ui, -apple-system, sans-serif !important;
      font-size: 13px !important;
      font-weight: 600 !important;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      border-bottom: 1px solid rgba(0, 255, 65, 0.3) !important;
    }

    td {
      color: #d0d0d0 !important;
    }

    tr {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
      transition: all 0.2s ease;
    }

    tr:hover {
      background: rgba(0, 255, 65, 0.03) !important;
    }

    /* Textos */
    .text-gray-100,
    .text-gray-200,
    .text-white {
      color: #e0e0e0 !important;
    }

    .text-gray-400,
    .text-gray-500 {
      color: #a0a0a0 !important;
    }

    h1, h2, h3, h4, h5, h6 {
      color: #e0e0e0 !important;
      text-shadow: none;
      font-family: system-ui, -apple-system, sans-serif !important;
      letter-spacing: 0.5px;
    }

    h1::after, h2::after, h3::after {
      content: '';
      display: block;
      width: 40px;
      height: 2px;
      background: linear-gradient(90deg, #00ff41, transparent);
      margin-top: 8px;
    }

    /* Canvas (Charts) */
    canvas {
      filter: none;
    }

    /* Scrollbar Cyberpunk Suave */
    ::-webkit-scrollbar {
      width: 8px;
      background: rgba(20, 25, 35, 0.8);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(0, 255, 65, 0.3);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 255, 65, 0.5);
    }

    /* Glow Effect Suave */
    .shadow-lg,
    .shadow-xl {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    }

    /* Accent Color para valores importantes */
    [id*="Value"],
    .kpi-value,
    .summary-total {
      color: #00ff41 !important;
      font-weight: 700 !important;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div id="dashboardMain" class="flex h-screen bg-[#1A1A1A] text-gray-100">
  <!-- Mobile Menu Button -->
  <button id="mobileMenuBtn" class="fixed top-4 left-4 z-50 lg:hidden bg-[#121212] p-2 rounded-lg text-gray-400 hover:text-[#00ff41] border border-gray-800">
    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
    </svg>
  </button>

  <!-- Mobile Overlay -->
  <div id="mobileOverlay" class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden"></div>

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed lg:static w-64 bg-[#121212] p-6 flex flex-col h-full z-40 -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
    <div>
      <div class="flex items-center justify-between mb-10">
        <span class="text-2xl font-bold" style="color: #e0e0e0; letter-spacing: 1px;">BARBER<span style="color: #00ff41; font-weight: 700;">PRO</span></span>
        <button id="closeSidebarBtn" class="lg:hidden text-gray-400 hover:text-red-500">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <nav>
        <ul id="sidebarNav">
          <li class="mb-4">
            <button data-view="dashboard" class="w-full text-left flex items-center px-4 py-2 rounded-lg bg-[#00ff41]/15 text-[#00ff41]">
              <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
              Dashboard
            </button>
          </li>
          <li class="mb-4">
            <button data-view="orders" class="w-full text-left flex items-center px-4 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors duration-200">
              <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2zm0 0h14"></path></svg>
              Agendamentos
            </button>
          </li>
          <li class="mb-4">
            <button data-view="barbers" class="w-full text-left flex items-center px-4 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors duration-200">
              <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
              Barbeiros
            </button>
          </li>
          <li class="mb-4">
            <button data-view="services" class="w-full text-left flex items-center px-4 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors duration-200">
              <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v2a2 2 0 01-2 2m0 0H5m14 0a2 2 0 002-2V9a2 2 0 00-2-2M5 11h14"></path></svg>
              Serviços
            </button>
          </li>
          <li class="mb-4">
            <button data-view="finance" class="w-full text-left flex items-center px-4 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors duration-200">
              <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              Financeiro
            </button>
          </li>
          <li class="mb-4">
            <button data-view="clients" class="w-full text-left flex items-center px-4 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors duration-200">
              <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h-10A3 3 0 014 17V7a3 3 0 013-3h10a3 3 0 013 3v10a3 3 0 01-3 3z"></path></svg>
              Clientes
            </button>
          </li>
          <li class="mb-4">
            <button data-view="settings" class="w-full text-left flex items-center px-4 py-2 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors duration-200">
              <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37h.001z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
              Configurações
            </button>
          </li>
        </ul>
      </nav>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-4 lg:p-8 overflow-y-auto w-full">
    <!-- Header -->
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 lg:mb-8 mt-12 lg:mt-0">
      <div class="relative w-full sm:max-w-md">
        <input type="text" placeholder="Pesquisar..." class="w-full bg-[#2A2A2A] text-gray-200 border border-gray-700 rounded-lg py-2 pl-10 pr-4 focus:outline-none focus:border-[#A38F5F]" />
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
      </div>
      <div class="flex items-center space-x-4">
        <button onclick="refreshDashboard()" class="text-gray-400 hover:text-[#A38F5F] transition-colors duration-200" title="Atualizar dados">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
        </button>
        <button onclick="logout()" class="text-gray-400 hover:text-red-500 transition-colors duration-200" title="Sair">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
        </button>
      </div>
    </header>

  <section id="view-dashboard">
  <!-- Stat cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6 mb-6 lg:mb-8">
      <div class="bg-[#2A2A2A] rounded-lg p-4 lg:p-6 shadow-lg border border-gray-800">
        <h3 class="text-gray-400 text-xs lg:text-sm mb-2">RECEITA DO MÊS</h3>
        <p class="text-2xl lg:text-3xl font-bold text-[#A38F5F]"><span id="revenueValue">R$ 0,00</span> <span class="text-green-500 text-sm lg:text-base ml-2">↑</span></p>
        <p class="text-gray-500 text-xs mt-1" id="revenueSubtext">Faturamento até o momento</p>
      </div>
      <div class="bg-[#2A2A2A] rounded-lg p-4 lg:p-6 shadow-lg border border-gray-800">
        <h3 class="text-gray-400 text-xs lg:text-sm mb-2">AGENDAMENTOS DO MÊS</h3>
        <p class="text-2xl lg:text-3xl font-bold text-white" id="appointmentsValue">0</p>
        <p class="text-gray-500 text-xs mt-1">Total no mês atual</p>
      </div>
      <div class="bg-[#2A2A2A] rounded-lg p-4 lg:p-6 shadow-lg border border-gray-800">
        <h3 class="text-gray-400 text-xs lg:text-sm mb-2">BARBEIROS ATIVOS</h3>
        <p class="text-2xl lg:text-3xl font-bold text-white" id="barbersValue">0</p>
        <p class="text-gray-500 text-xs mt-1">Atualmente online</p>
      </div>
    </div>

  <!-- Charts row -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6 mb-6 lg:mb-8">
      <div class="bg-[#2A2A2A] rounded-lg p-4 lg:p-6 shadow-lg border border-gray-800">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-2">
          <div>
            <h3 class="text-gray-200 text-base lg:text-lg font-semibold">📈 PROGRESSO DA META MENSAL</h3>
            <p class="text-gray-400 text-xs lg:text-sm mt-1">Acompanhamento diário do mês</p>
          </div>
          <div class="text-left sm:text-right">
            <div class="text-xl lg:text-2xl font-bold text-emerald-400" id="goalProgressPercent">0%</div>
            <div class="text-xs text-gray-400" id="goalProgressLabel">da meta</div>
          </div>
        </div>
        <div class="h-48 sm:h-56 mt-4">
          <canvas id="monthlyGoalChart" class="w-full h-full"></canvas>
        </div>
      </div>

      <div class="bg-[#2A2A2A] rounded-lg p-4 lg:p-6 shadow-lg border border-gray-800">
        <h3 class="text-gray-200 text-base lg:text-lg font-semibold mb-2">👥 TOP CLIENTES DO MÊS</h3>
        <p class="text-gray-400 text-xs lg:text-sm mb-4">Clientes que mais frequentaram</p>
        <div class="h-48 sm:h-64 flex items-center justify-center">
          <canvas id="topClientsChart" class="max-h-full"></canvas>
        </div>
        <div id="topClientsLegend" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs"></div>
      </div>
    </div>

  <!-- Recent appointments -->
  <div class="bg-[#2A2A2A] rounded-lg p-4 lg:p-6 shadow-lg border border-gray-800">
      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-4">
        <h3 class="text-gray-200 text-base lg:text-lg font-semibold">AGENDAMENTOS RECENTES</h3>
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
          <input type="text" placeholder="Pesquisar..." class="bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-1 px-3 text-sm focus:outline-none focus:border-[#A38F5F]" />
          <button class="px-3 py-1 rounded-md bg-[#A38F5F] text-white text-sm whitespace-nowrap">Filtros</button>
        </div>
      </div>
      <div class="overflow-x-auto -mx-4 lg:mx-0">
        <table class="w-full text-left text-gray-300 min-w-[600px]">
          <thead class="text-xs text-gray-400 uppercase bg-gray-800">
            <tr>
              <th scope="col" class="px-3 lg:px-6 py-3">Cliente</th>
              <th scope="col" class="px-3 lg:px-6 py-3">Barbeiro</th>
              <th scope="col" class="px-3 lg:px-6 py-3">Data</th>
              <th scope="col" class="px-3 lg:px-6 py-3">Serviço</th>
              <th scope="col" class="px-3 lg:px-6 py-3">Hora</th>
              <th scope="col" class="px-3 lg:px-6 py-3">Status</th>
            </tr>
          </thead>
          <tbody id="recentTbody">
            <tr>
              <td class="px-3 lg:px-6 py-4 text-gray-400" colspan="6">Carregando...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    </section>

    <!-- Finance View -->
    <section id="view-finance" class="hidden space-y-6">
      <!-- Header com Período -->
      <div class="bg-gradient-to-r from-emerald-900/20 to-emerald-800/20 rounded-lg p-6 shadow-lg border border-emerald-700/30">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-2xl font-bold text-emerald-400 mb-2">💰 Central Financeira</h2>
            <p class="text-gray-400 text-sm">Análise completa do desempenho financeiro</p>
          </div>
          <div class="flex gap-2">
            <button onclick="setFinancePeriod('today')" id="finance-today" class="px-4 py-2 rounded-md bg-gray-700 text-gray-300 hover:bg-emerald-600 hover:text-white transition-colors text-sm">Hoje</button>
            <button onclick="setFinancePeriod('week')" id="finance-week" class="px-4 py-2 rounded-md bg-gray-700 text-gray-300 hover:bg-emerald-600 hover:text-white transition-colors text-sm">Semana</button>
            <button onclick="setFinancePeriod('month')" id="finance-month" class="px-4 py-2 rounded-md bg-emerald-600 text-white transition-colors text-sm">Mês</button>
            <button onclick="setFinancePeriod('year')" id="finance-year" class="px-4 py-2 rounded-md bg-gray-700 text-gray-300 hover:bg-emerald-600 hover:text-white transition-colors text-sm">Ano</button>
          </div>
        </div>
      </div>

      <!-- Cards de Métricas Principais -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <!-- Faturamento Total -->
        <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border-l-4 border-emerald-500 relative overflow-hidden">
          <div class="absolute top-0 right-0 opacity-10">
            <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20"><path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"></path><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"></path></svg>
          </div>
          <h3 class="text-gray-400 text-xs uppercase tracking-wide mb-2">Faturamento</h3>
          <p class="text-3xl font-bold text-emerald-400 mb-1" id="finance-revenue">R$ 0,00</p>
          <div class="flex items-center text-xs">
            <span class="text-emerald-500" id="finance-revenue-change">+0%</span>
            <span class="text-gray-500 ml-2">vs período anterior</span>
          </div>
        </div>

        <!-- Ticket Médio -->
        <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border-l-4 border-blue-500 relative overflow-hidden">
          <div class="absolute top-0 right-0 opacity-10">
            <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path></svg>
          </div>
          <h3 class="text-gray-400 text-xs uppercase tracking-wide mb-2">Ticket Médio</h3>
          <p class="text-3xl font-bold text-blue-400 mb-1" id="finance-avg-ticket">R$ 0,00</p>
          <div class="flex items-center text-xs">
            <span class="text-blue-500" id="finance-ticket-change">+0%</span>
            <span class="text-gray-500 ml-2">vs período anterior</span>
          </div>
        </div>

        <!-- Total de Clientes -->
        <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border-l-4 border-purple-500 relative overflow-hidden">
          <div class="absolute top-0 right-0 opacity-10">
            <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path></svg>
          </div>
          <h3 class="text-gray-400 text-xs uppercase tracking-wide mb-2">Clientes Atendidos</h3>
          <p class="text-3xl font-bold text-purple-400 mb-1" id="finance-clients">0</p>
          <div class="flex items-center text-xs">
            <span class="text-purple-500" id="finance-clients-change">+0%</span>
            <span class="text-gray-500 ml-2">vs período anterior</span>
          </div>
        </div>

        <!-- Agendamentos -->
        <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border-l-4 border-orange-500 relative overflow-hidden">
          <div class="absolute top-0 right-0 opacity-10">
            <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
          </div>
          <h3 class="text-gray-400 text-xs uppercase tracking-wide mb-2">Agendamentos</h3>
          <p class="text-3xl font-bold text-orange-400 mb-1" id="finance-bookings">0</p>
          <div class="flex items-center text-xs">
            <span class="text-orange-500" id="finance-bookings-change">+0%</span>
            <span class="text-gray-500 ml-2">vs período anterior</span>
          </div>
        </div>
      </div>

      <!-- Metas e Projeções -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Metas do Mês -->
        <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border border-gray-800">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-gray-200 text-lg font-semibold flex items-center">
              🎯 Metas do Mês
            </h3>
            <button onclick="openGoalsModal()" class="text-emerald-400 hover:text-emerald-300 text-sm">Editar</button>
          </div>
          
          <!-- Meta de Faturamento -->
          <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
              <span class="text-gray-400 text-sm">Faturamento</span>
              <span class="text-white text-sm font-semibold"><span id="goal-revenue-current">R$ 0</span> / <span id="goal-revenue-target">R$ 10.000</span></span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
              <div id="goal-revenue-bar" class="bg-gradient-to-r from-emerald-500 to-emerald-400 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p class="text-xs text-gray-500 mt-1"><span id="goal-revenue-percent">0%</span> da meta alcançada</p>
          </div>

          <!-- Meta de Clientes -->
          <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
              <span class="text-gray-400 text-sm">Novos Clientes</span>
              <span class="text-white text-sm font-semibold"><span id="goal-clients-current">0</span> / <span id="goal-clients-target">50</span></span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
              <div id="goal-clients-bar" class="bg-gradient-to-r from-blue-500 to-blue-400 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p class="text-xs text-gray-500 mt-1"><span id="goal-clients-percent">0%</span> da meta alcançada</p>
          </div>

          <!-- Meta de Agendamentos -->
          <div>
            <div class="flex justify-between items-center mb-2">
              <span class="text-gray-400 text-sm">Agendamentos</span>
              <span class="text-white text-sm font-semibold"><span id="goal-bookings-current">0</span> / <span id="goal-bookings-target">100</span></span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
              <div id="goal-bookings-bar" class="bg-gradient-to-r from-purple-500 to-purple-400 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p class="text-xs text-gray-500 mt-1"><span id="goal-bookings-percent">0%</span> da meta alcançada</p>
          </div>
        </div>

        <!-- Projeções -->
        <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border border-gray-800">
          <h3 class="text-gray-200 text-lg font-semibold mb-4 flex items-center">
            📈 Projeções Inteligentes
          </h3>
          
          <div class="space-y-4">
            <!-- Projeção Mensal -->
            <div class="bg-gray-800/50 rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-gray-400 text-sm">Projeção p/ Final do Mês</span>
                <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
              </div>
              <p class="text-2xl font-bold text-emerald-400" id="projection-month">R$ 0,00</p>
              <p class="text-xs text-gray-500 mt-1">Baseado na média diária atual</p>
            </div>

            <!-- Projeção Trimestral -->
            <div class="bg-gray-800/50 rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-gray-400 text-sm">Projeção Trimestral</span>
                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
              </div>
              <p class="text-2xl font-bold text-blue-400" id="projection-quarter">R$ 0,00</p>
              <p class="text-xs text-gray-500 mt-1">Próximos 3 meses</p>
            </div>

            <!-- Taxa de Crescimento -->
            <div class="bg-gray-800/50 rounded-lg p-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-gray-400 text-sm">Taxa de Crescimento</span>
                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
              </div>
              <p class="text-2xl font-bold text-purple-400" id="growth-rate">+0%</p>
              <p class="text-xs text-gray-500 mt-1">Comparado ao mês anterior</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Gráfico de Faturamento -->
      <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border border-gray-800">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-gray-200 text-lg font-semibold">📊 Evolução do Faturamento</h3>
          <div class="flex gap-2">
            <button onclick="setRevenueChart('daily')" id="chart-daily" class="px-3 py-1 rounded-md bg-gray-700 text-gray-300 hover:bg-emerald-600 hover:text-white transition-colors text-sm">Diário</button>
            <button onclick="setRevenueChart('weekly')" id="chart-weekly" class="px-3 py-1 rounded-md bg-emerald-600 text-white transition-colors text-sm">Semanal</button>
            <button onclick="setRevenueChart('monthly')" id="chart-monthly" class="px-3 py-1 rounded-md bg-gray-700 text-gray-300 hover:bg-emerald-600 hover:text-white transition-colors text-sm">Mensal</button>
          </div>
        </div>
        <div class="h-80">
          <canvas id="revenueChartFinance"></canvas>
        </div>
      </div>

      <!-- Análise por Serviço e Forma de Pagamento -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Top Serviços -->
        <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border border-gray-800">
          <h3 class="text-gray-200 text-lg font-semibold mb-4">🏆 Serviços Mais Rentáveis</h3>
          <div id="top-services" class="space-y-3">
            <!-- Será preenchido dinamicamente -->
          </div>
        </div>

        <!-- Formas de Pagamento -->
        <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border border-gray-800">
          <h3 class="text-gray-200 text-lg font-semibold mb-4">💳 Formas de Pagamento</h3>
          <div class="h-64">
            <canvas id="paymentMethodsChart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Orders View -->
    <section id="view-orders" class="hidden">
      <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border border-gray-800 mb-4">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
          <div>
            <h3 class="text-gray-200 text-lg font-semibold">Agendamentos</h3>
            <p class="text-gray-400 text-sm">Gerencie o status dos agendamentos</p>
          </div>
          <div class="flex gap-2">
            <select id="ordersStatusFilter" class="bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm">
              <option value="all">Todos</option>
              <option value="Pendente">Pendentes</option>
              <option value="Pago">Pagos</option>
              <option value="Cancelado">Cancelados</option>
            </select>
            <input id="ordersSearch" type="text" placeholder="Buscar..." class="bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm" />
          </div>
        </div>
      </div>
      <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border border-gray-800 overflow-x-auto">
        <table class="w-full text-left text-gray-300">
          <thead class="text-xs text-gray-400 uppercase bg-gray-800">
            <tr>
              <th class="px-6 py-3">ID</th>
              <th class="px-6 py-3">Cliente</th>
              <th class="px-6 py-3">Serviço</th>
              <th class="px-6 py-3">Valor</th>
              <th class="px-6 py-3">Data</th>
              <th class="px-6 py-3">Status</th>
              <th class="px-6 py-3">Ações</th>
            </tr>
          </thead>
          <tbody id="ordersTbodyDW">
            <tr><td colspan="7" class="px-6 py-4 text-gray-400">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Clients View -->
    <section id="view-clients" class="hidden">
      <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border border-gray-800 mb-4">
        <div class="flex items-end justify-between gap-4">
          <div>
            <h3 class="text-gray-200 text-lg font-semibold">Clientes</h3>
            <p class="text-gray-400 text-sm">Lista de clientes consolidados por telefone</p>
          </div>
          <input id="clientSearchDW" type="text" placeholder="Buscar cliente..." class="bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm" />
        </div>
      </div>
      <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border border-gray-800 overflow-x-auto">
        <table class="w-full text-left text-gray-300">
          <thead class="text-xs text-gray-400 uppercase bg-gray-800">
            <tr>
              <th class="px-6 py-3">Nome</th>
              <th class="px-6 py-3">Telefone</th>
              <th class="px-6 py-3">Últ. Visita</th>
              <th class="px-6 py-3">Total Gasto</th>
              <th class="px-6 py-3">Agendamentos</th>
            </tr>
          </thead>
          <tbody id="clientsTbodyDW">
            <tr><td colspan="5" class="px-6 py-4 text-gray-400">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Settings View -->
    <section id="view-settings" class="hidden space-y-6">
      <!-- Equipe -->
      <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border border-gray-800">
        <h3 class="text-gray-200 text-lg font-semibold mb-2">Equipe</h3>
        <p class="text-gray-400 text-sm mb-4">Número de barbeiros ativos na barbearia (atualizado automaticamente)</p>
        <div class="mb-3 p-3 bg-[#9D4EDD]/10 border border-[#9D4EDD]/30 rounded-md">
          <p class="text-sm text-[#9D4EDD]">
            💡 <strong>Dica:</strong> Gerencie seus barbeiros na seção <button onclick="switchViewDW('barbers'); document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('bg-[#A38F5F]/20','text-[#A38F5F]')); document.querySelector('[data-view=barbers]').classList.add('bg-[#A38F5F]/20','text-[#A38F5F]');" class="underline hover:text-white transition-colors">"Barbeiros"</button> do menu.
          </p>
        </div>
        <div class="flex items-center gap-3 flex-wrap">
          <label class="text-sm text-gray-300">Barbeiros Ativos:</label>
          <input id="activeBarbersInputDW" type="number" min="0" max="50" class="w-28 bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm" value="0" placeholder="Ex: 3" readonly />
          <span class="text-xs text-gray-500">(somente leitura)</span>
          <span id="activeBarbersStatusDW" class="text-sm font-semibold"></span>
        </div>
      </div>

      <!-- Horários Disponíveis -->
      <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border border-gray-800">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="text-gray-200 text-lg font-semibold">Horários Disponíveis</h3>
            <p class="text-gray-400 text-sm">Gerencie a grade de horários por dia</p>
          </div>
          <button id="toggleCalendarBtnDW" onclick="toggleWeeklyCalendarDW()" class="px-3 py-2 rounded-md border border-gray-700 hover:bg-gray-700 text-sm">Ver calendário semanal</button>
        </div>
        <div id="weeklyCalendarViewDW" class="hidden mb-4 p-4 bg-[#1A1A1A] border border-gray-700 rounded-lg">
          <h4 class="text-[#A38F5F] font-semibold mb-3">Grade Semanal de Horários</h4>
          <div id="weeklyCalendarGridDW" class="grid md:grid-cols-3 gap-3"></div>
        </div>
        <div class="flex flex-wrap items-center gap-3 mb-3">
          <label class="text-sm">Dia da semana:</label>
          <select id="slotDaySelectDW" class="bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm">
            <option value="0">Domingo</option>
            <option value="1">Segunda-feira</option>
            <option value="2">Terça-feira</option>
            <option value="3">Quarta-feira</option>
            <option value="4">Quinta-feira</option>
            <option value="5">Sexta-feira</option>
            <option value="6">Sábado</option>
          </select>
          <button onclick="copySlotsFromDayDW()" class="px-3 py-2 rounded-md border border-gray-700 hover:bg-gray-700 text-sm">Copiar de outro dia</button>
          <button onclick="useGlobalDefaultSlotsDW()" class="px-3 py-2 rounded-md border border-gray-700 hover:bg-gray-700 text-sm">Usar padrão global</button>
        </div>
        <div class="flex flex-wrap items-center gap-3 mb-3">
          <input id="newSlotInputDW" type="time" step="300" value="09:00" class="bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm" />
          <button onclick="addAvailableSlotDW()" class="px-3 py-2 rounded-md bg-emerald-600 text-white text-sm">Adicionar neste dia</button>
          <button onclick="addAvailableSlotToAllDaysDW()" class="px-3 py-2 rounded-md border border-purple-500 text-purple-300 hover:bg-purple-900/30 text-sm">Adicionar em todos os dias</button>
        </div>
        <div class="flex flex-wrap items-center gap-3 mb-3 border-t border-gray-700 pt-3">
          <strong class="text-sm text-gray-400">Gerar intervalos:</strong>
          <label class="text-sm">Início <input id="genStartDWW" type="time" value="09:00" class="ml-2 bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-1 px-2 text-sm" /></label>
          <label class="text-sm">Fim <input id="genEndDW" type="time" value="18:00" class="ml-2 bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-1 px-2 text-sm" /></label>
          <label class="text-sm">Passo (min) <input id="genStepDW" type="number" value="30" min="5" step="5" class="ml-2 w-20 bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-1 px-2 text-sm" /></label>
          <button onclick="generateForSelectedDayDW()" class="px-3 py-2 rounded-md border border-gray-700 hover:bg-gray-700 text-sm">Gerar para este dia</button>
          <button onclick="applyPresetTueFriSatDW()" class="px-3 py-2 rounded-md border border-gray-700 hover:bg-gray-700 text-sm">Aplicar Ter–Sex 09–18 / Sáb 09–16 (30m)</button>
        </div>
        <div id="availableSlotsListDW" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- Dias Fechados -->
      <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border border-gray-800">
        <h3 class="text-gray-200 text-lg font-semibold mb-2">Dias Fechados</h3>
        <p class="text-gray-400 text-sm mb-3">Defina datas em que a barbearia estará fechada</p>
        <div class="flex flex-wrap gap-2 mb-3">
          <button onclick="toggleAllSundaysDW()" class="px-3 py-2 rounded-md border border-[#A38F5F] text-[#A38F5F] hover:bg-[#A38F5F]/10 text-sm">
            <span id="sundayBtnTextDW">Fechar todos os domingos</span>
          </button>
          <button onclick="toggleAllMondaysDW()" class="px-3 py-2 rounded-md border border-[#A38F5F] text-[#A38F5F] hover:bg-[#A38F5F]/10 text-sm">
            <span id="mondayBtnTextDW">Fechar todas as segundas</span>
          </button>
        </div>
        <div class="flex flex-wrap items-center gap-2 mb-3">
          <input id="closedDateInputDW" type="date" class="bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm" />
          <button onclick="addClosedDateDW()" class="px-3 py-2 rounded-md bg-emerald-600 text-white text-sm">Adicionar</button>
        </div>
        <div id="closedDatesListDW" class="space-y-2"></div>
      </div>

      <!-- Segurança -->
      <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border border-gray-800">
        <h3 class="text-gray-200 text-lg font-semibold mb-2">Segurança</h3>
        <div class="grid md:grid-cols-3 gap-3">
          <div>
            <label class="block text-sm text-gray-300 mb-1">Senha atual</label>
            <input id="currentAdminPasswordDW" type="password" class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm" />
          </div>
          <div>
            <label class="block text-sm text-gray-300 mb-1">Nova senha</label>
            <input id="newAdminPasswordDW" type="password" class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm" />
          </div>
          <div>
            <label class="block text-sm text-gray-300 mb-1">Confirmar nova senha</label>
            <input id="confirmAdminPasswordDW" type="password" class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm" />
          </div>
        </div>
        <div class="flex gap-2 mt-3">
          <button onclick="changeAdminPasswordDW()" class="px-3 py-2 rounded-md bg-[#A38F5F] text-white text-sm">Salvar nova senha</button>
          <button onclick="resetAdminPasswordToDefaultDW()" class="px-3 py-2 rounded-md border border-gray-700 hover:bg-gray-700 text-sm">Restaurar padrão</button>
        </div>
      </div>

      <!-- Limpeza de Dados -->
      <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border border-red-900/50">
        <h3 class="text-red-400 text-lg font-semibold mb-2">⚠️ Limpeza de Dados</h3>
        <p class="text-gray-400 text-sm mb-4">Remova dados de teste ou limpe todo o sistema</p>
        
        <div class="space-y-3">
          <div class="p-4 bg-[#1A1A1A] border border-gray-700 rounded-lg">
            <h4 class="text-gray-200 font-semibold mb-2">Limpar Agendamentos</h4>
            <p class="text-gray-400 text-sm mb-3">Remove todos os agendamentos do sistema (barbeiros e serviços permanecerão)</p>
            <button onclick="clearBookingsDW()" class="px-4 py-2 rounded-md bg-orange-600 hover:bg-orange-700 text-white text-sm font-semibold">
              🗑️ Limpar todos os agendamentos
            </button>
          </div>

          <div class="p-4 bg-[#1A1A1A] border border-red-700 rounded-lg">
            <h4 class="text-red-400 font-semibold mb-2">Limpar Tudo</h4>
            <p class="text-gray-400 text-sm mb-3">⚠️ ATENÇÃO: Remove TODOS os dados do sistema (agendamentos, barbeiros, serviços, configurações)</p>
            <button onclick="clearAllDataDW()" class="px-4 py-2 rounded-md bg-red-600 hover:bg-red-700 text-white text-sm font-semibold">
              ⛔ Limpar TODOS os dados
            </button>
          </div>
        </div>
      </div>

      <!-- Backup / Restauração -->
      <div class="bg-[#2A2A2A] rounded-lg p-6 shadow-lg border border-gray-800">
        <h3 class="text-gray-200 text-lg font-semibold mb-2">Backup e Restauração</h3>
        <div class="flex flex-wrap gap-2">
          <button onclick="exportBackupDW()" class="px-3 py-2 rounded-md bg-emerald-600 text-white text-sm">Exportar Backup</button>
          <label class="px-3 py-2 rounded-md border border-gray-700 hover:bg-gray-700 text-sm cursor-pointer">
            Importar Backup
            <input id="importBackupInputDW" type="file" accept="application/json" class="hidden" onchange="importBackupDW(this)" />
          </label>
        </div>
      </div>
    </section>

    <!-- Services View -->
    <section id="view-services" class="hidden space-y-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-100">Gerenciar Serviços</h2>
        <button onclick="openAddServiceModalDW()" class="px-4 py-2 rounded-md bg-[#00F5D4] text-gray-900 font-semibold hover:bg-[#00F5D4]/80 transition-colors">
          ➕ Novo Serviço
        </button>
      </div>

      <!-- Services Grid -->
      <div id="servicesGridDW" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Cards de serviços serão inseridos aqui -->
      </div>
    </section>

    <!-- Barbers View -->
    <section id="view-barbers" class="hidden space-y-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-100">Gerenciar Barbeiros</h2>
        <button onclick="openAddBarberModalDW()" class="px-4 py-2 rounded-md bg-[#9D4EDD] text-white font-semibold hover:bg-[#9D4EDD]/80 transition-colors">
          ➕ Novo Barbeiro
        </button>
      </div>

      <!-- Barbers Grid -->
      <div id="barbersGridDW" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Cards de barbeiros serão inseridos aqui -->
      </div>
    </section>
  </main>
</div>

<!-- Modal Adicionar/Editar Barbeiro -->
<div id="barberModalDW" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
  <div class="bg-[#1A1A1A] border border-gray-700 rounded-xl p-6 w-full max-w-md shadow-2xl">
    <div class="flex items-center justify-between mb-4">
      <h3 id="barberModalTitleDW" class="text-xl font-bold text-gray-100">Novo Barbeiro</h3>
      <button onclick="closeBarberModalDW()" class="text-gray-400 hover:text-gray-200 text-2xl">&times;</button>
    </div>
    
    <div class="space-y-4">
      <input type="hidden" id="barberEditIdDW" value="" />
      
      <div>
        <label class="block text-sm text-gray-300 mb-1">Nome do Barbeiro *</label>
        <input id="barberNameInputDW" type="text" placeholder="Ex: João Silva" class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm focus:border-[#9D4EDD] focus:outline-none" />
      </div>
      
      <div>
        <label class="block text-sm text-gray-300 mb-1">Telefone</label>
        <input id="barberPhoneInputDW" type="tel" placeholder="(11) 98765-4321" class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm focus:border-[#9D4EDD] focus:outline-none" />
      </div>
      
      <div>
        <label class="block text-sm text-gray-300 mb-1">E-mail</label>
        <input id="barberEmailInputDW" type="email" placeholder="joao@exemplo.com" class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm focus:border-[#9D4EDD] focus:outline-none" />
      </div>
      
      <div>
        <label class="block text-sm text-gray-300 mb-1">Especialidades</label>
        <input id="barberSpecialtiesInputDW" type="text" placeholder="Ex: Cortes, Barba, Degradê" class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm focus:border-[#9D4EDD] focus:outline-none" />
      </div>
      
      <div>
        <label class="flex items-center gap-2 cursor-pointer">
          <input id="barberActiveInputDW" type="checkbox" checked class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-[#9D4EDD] focus:ring-[#9D4EDD] focus:ring-offset-0" />
          <span class="text-sm text-gray-300">Barbeiro ativo</span>
        </label>
      </div>
    </div>
    
    <div class="flex gap-2 mt-6">
      <button onclick="saveBarberDW()" class="flex-1 px-4 py-2 rounded-md bg-[#9D4EDD] text-white font-semibold hover:bg-[#9D4EDD]/80 transition-colors">
        💾 Salvar
      </button>
      <button onclick="closeBarberModalDW()" class="px-4 py-2 rounded-md border border-gray-600 text-gray-300 hover:bg-gray-700 transition-colors">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal Adicionar/Editar Serviço -->
<div id="serviceModalDW" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
  <div class="bg-[#1A1A1A] border border-gray-700 rounded-xl p-6 w-full max-w-md shadow-2xl">
    <div class="flex items-center justify-between mb-4">
      <h3 id="serviceModalTitleDW" class="text-xl font-bold text-gray-100">Novo Serviço</h3>
      <button onclick="closeServiceModalDW()" class="text-gray-400 hover:text-gray-200 text-2xl">&times;</button>
    </div>
    
    <div class="space-y-4">
      <input type="hidden" id="serviceEditIdDW" value="" />
      
      <div>
        <label class="block text-sm text-gray-300 mb-1">Nome do Serviço *</label>
        <input id="serviceNameInputDW" type="text" placeholder="Ex: Corte Simples" class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm focus:border-[#00F5D4] focus:outline-none" />
      </div>
      
      <div>
        <label class="block text-sm text-gray-300 mb-1">Valor (R$) *</label>
        <input id="serviceValueInputDW" type="number" step="0.01" min="0" placeholder="Ex: 35.00" class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm focus:border-[#00F5D4] focus:outline-none" />
      </div>
      
      <div>
        <label class="block text-sm text-gray-300 mb-1">Duração (minutos) *</label>
        <input id="serviceDurationInputDW" type="number" min="5" step="5" placeholder="Ex: 30" class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm focus:border-[#00F5D4] focus:outline-none" />
      </div>
      
      <div>
        <label class="block text-sm text-gray-300 mb-1">Descrição (opcional)</label>
        <textarea id="serviceDescInputDW" rows="3" placeholder="Descreva o serviço..." class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-2 px-3 text-sm focus:border-[#00F5D4] focus:outline-none resize-none"></textarea>
      </div>
    </div>
    
    <div class="flex gap-2 mt-6">
      <button onclick="saveServiceDW()" class="flex-1 px-4 py-2 rounded-md bg-[#00F5D4] text-gray-900 font-semibold hover:bg-[#00F5D4]/80 transition-colors">
        💾 Salvar
      </button>
      <button onclick="closeServiceModalDW()" class="px-4 py-2 rounded-md border border-gray-600 text-gray-300 hover:bg-gray-700 transition-colors">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal Editar Metas -->
<div id="goalsModalDW" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
  <div class="bg-[#1A1A1A] border border-emerald-700/50 rounded-xl p-6 w-full max-w-md shadow-2xl">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-bold text-emerald-400">🎯 Editar Metas do Mês</h3>
      <button onclick="closeGoalsModalDW()" class="text-gray-400 hover:text-gray-200 text-2xl">&times;</button>
    </div>
    
    <p class="text-gray-400 text-sm mb-6">Defina suas metas mensais para acompanhar o desempenho da barbearia.</p>
    
    <div class="space-y-5">
      <div>
        <label class="block text-sm text-gray-300 mb-2">💰 Meta de Faturamento (R$)</label>
        <input id="goalRevenueInputDW" type="number" step="100" min="0" placeholder="Ex: 10000" class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-3 px-4 text-base focus:border-emerald-500 focus:outline-none" />
        <p class="text-xs text-gray-500 mt-1">Quanto você espera faturar este mês?</p>
      </div>
      
      <div>
        <label class="block text-sm text-gray-300 mb-2">👥 Meta de Novos Clientes</label>
        <input id="goalClientsInputDW" type="number" min="0" placeholder="Ex: 50" class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-3 px-4 text-base focus:border-blue-500 focus:outline-none" />
        <p class="text-xs text-gray-500 mt-1">Quantos novos clientes você quer atender?</p>
      </div>
      
      <div>
        <label class="block text-sm text-gray-300 mb-2">📅 Meta de Agendamentos</label>
        <input id="goalBookingsInputDW" type="number" min="0" placeholder="Ex: 100" class="w-full bg-gray-700 text-gray-200 border border-gray-600 rounded-md py-3 px-4 text-base focus:border-purple-500 focus:outline-none" />
        <p class="text-xs text-gray-500 mt-1">Quantos agendamentos você espera realizar?</p>
      </div>
    </div>
    
    <div class="flex gap-2 mt-6">
      <button onclick="saveGoalsDW()" class="flex-1 px-4 py-3 rounded-md bg-emerald-600 text-white font-semibold hover:bg-emerald-500 transition-colors">
        💾 Salvar Metas
      </button>
      <button onclick="closeGoalsModalDW()" class="px-4 py-3 rounded-md border border-gray-600 text-gray-300 hover:bg-gray-700 transition-colors">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Login Overlay (fora do #dashboardMain para evitar ser ocultado junto) -->
<div id="loginOverlay" class="hacker-login-overlay fixed inset-0 flex items-center justify-center p-4 hidden z-50">
  <!-- Matrix Background Effect -->
  <div class="matrix-bg" id="matrixBg"></div>
  
  <div class="hacker-login-container rounded-xl p-8 w-full max-w-md relative">
    <!-- Scan Line Effect -->
    <div class="scan-line"></div>
    
    <!-- Title with Glitch Effect -->
    <h1 class="glitch-title text-center mb-8" data-text="ACESSO // SISTEMA">
      ACESSO // SISTEMA
    </h1>
    
    <!-- Login Form -->
    <form onsubmit="event.preventDefault(); validateLogin();" class="space-y-6">
      <!-- Username Field (hidden but required for form) -->
      <div class="mb-6">
        <label for="adminUser" class="block mb-3">
          <span class="typewriter-label" data-text="USUÁRIO:">USUÁRIO:</span>
        </label>
        <input 
          type="text" 
          id="adminUser" 
          class="hacker-input w-full rounded-lg" 
          value="ADMIN"
          readonly
          placeholder=">>> ADMIN"
        />
      </div>
      
      <!-- Password Field -->
      <div class="mb-6">
        <label for="adminPwd" class="block mb-3">
          <span class="typewriter-label" data-text="SENHA:">SENHA:</span>
        </label>
        <input 
          type="password" 
          id="adminPwd" 
          class="hacker-input w-full rounded-lg" 
          placeholder=">>> Digite a senha"
          required
        />
      </div>
      
      <!-- Submit Button -->
      <button type="submit" class="hacker-btn w-full rounded-lg">
        [ ACESSAR SISTEMA ]
      </button>
      
      <!-- Back Button -->
      <button 
        type="button" 
        onclick="window.location.href='index.html'" 
        class="w-full mt-4 px-4 py-3 rounded-lg border-2 border-red-500 text-red-500 hover:bg-red-500 hover:text-black transition-all duration-300 font-['VT323'] text-xl"
        style="letter-spacing: 2px;"
      >
        [ CANCELAR ]
      </button>
    </form>
    
    <!-- Footer -->
    <p class="hacker-footer mt-6">
      🔒 Protocolo de Segurança Omega Ativo
    </p>
  </div>
</div>

<script>
  console.log('[INIT] Script carregando...');
  const API_BASE = localStorage.getItem('API_BASE') || 'http://localhost:3333';
  console.log('[INIT] API_BASE:', API_BASE);

  // Auth helpers (usa a mesma senha do index.html)
  const DEFAULT_ADMIN_PASSWORD = 'bf12025';
  function getAdminPassword() {
    try {
      const saved = localStorage.getItem('adminPassword');
      return (saved && saved.length) ? saved : DEFAULT_ADMIN_PASSWORD;
    } catch (e) {
      return DEFAULT_ADMIN_PASSWORD;
    }
  }

  // Função showLogin movida para o final com os efeitos hacker

  function hideLogin() {
    const overlay = document.getElementById('loginOverlay');
    const main = document.getElementById('dashboardMain');
    console.log('[HIDELOGIN] Escondendo overlay, mostrando dashboard');
    if (overlay) {
      overlay.classList.add('hidden');
      overlay.style.display = 'none';
    }
    if (main) {
      main.style.display = 'flex';
    }
  }

  function validateLogin() {
    const input = document.getElementById('adminPwd');
    const pwd = input ? input.value : '';
    console.log('[LOGIN] Tentando validar senha...');
    if (!pwd) {
      console.log('[LOGIN] Campo vazio');
      return;
    }
    const expected = getAdminPassword();
    console.log('[LOGIN] Comparando senha (length):', pwd.length, 'vs', expected.length);
    if (pwd === expected) {
      console.log('[LOGIN] Senha correta! Autenticando...');
      sessionStorage.setItem('admin_authenticated', 'true');
      sessionStorage.setItem('admin_auth_time', Date.now());
      hideLogin();
      refreshDashboard();
    } else {
      console.log('[LOGIN] Senha incorreta');
      // feedback simples
      if (input) {
        input.value = '';
        input.classList.add('ring-2','ring-red-500');
        setTimeout(() => input.classList.remove('ring-2','ring-red-500'), 800);
      }
    }
  }

  // Verificar autenticação e decidir o que mostrar
  function checkAuthDW() {
    console.log('[CHECKAUTH] Verificando autenticação...');
    const isAuth = sessionStorage.getItem('admin_authenticated');
    const authTime = sessionStorage.getItem('admin_auth_time');
    const now = Date.now();
    const fourHours = 4 * 60 * 60 * 1000;
    const valid = isAuth && authTime && ((now - parseInt(authTime)) <= fourHours);
    console.log('[CHECKAUTH] isAuth:', isAuth, 'authTime:', authTime, 'valid:', valid);
    if (!valid) {
      console.log('[CHECKAUTH] Sessão inválida, mostrando login');
      sessionStorage.removeItem('admin_authenticated');
      sessionStorage.removeItem('admin_auth_time');
      showLogin();
    } else {
      console.log('[CHECKAUTH] Sessão válida, mostrando dashboard');
      // Já está autenticado, garante que o dashboard está visível
      hideLogin();
    }
  }
  
  // Executar ao carregar
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkAuthDW);
  } else {
    checkAuthDW();
  }

  function currencyBRL(v) {
    try { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0); } catch { return `R$ ${Number(v||0).toFixed(2)}`; }
  }

  async function loadStats() {
    // Calcular receita do mês atual do localStorage
    const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    const currentDay = now.getDate();
    
    // Total de dias no mês
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const progressPercent = Math.round((currentDay / daysInMonth) * 100);
    
    // Filtrar agendamentos do mês atual (não cancelados)
    const monthBookings = bookings.filter(b => {
      const bookingDate = new Date(b.dataISO || b.data);
      return bookingDate.getMonth() === currentMonth && 
             bookingDate.getFullYear() === currentYear && 
             b.status !== 'Cancelado';
    });
    
    // Calcular receita total do mês
    const monthRevenue = monthBookings.reduce((sum, b) => {
      return sum + (parseFloat(b.valor) || 0);
    }, 0);
    
    // Contar agendamentos do mês
    const monthAppointments = monthBookings.length;
    
    // Contar barbeiros ativos
    const barbers = JSON.parse(localStorage.getItem('barbers') || '[]');
    const activeBarbers = barbers.filter(b => b.active !== false).length;
    
    // Atualizar UI
    document.getElementById('revenueValue').textContent = currencyBRL(monthRevenue);
    document.getElementById('appointmentsValue').textContent = monthAppointments;
    document.getElementById('barbersValue').textContent = activeBarbers;
    
    // Atualizar subtexto com progresso do mês
    const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    const revenueSubtext = document.getElementById('revenueSubtext');
    if (revenueSubtext) {
      revenueSubtext.textContent = `${monthNames[currentMonth]} - ${progressPercent}% do mês`;
    }
    
    console.log('[STATS] Receita do mês:', currencyBRL(monthRevenue), 'Agendamentos:', monthAppointments);
    
    // Tentar carregar da API também (se disponível)
    try {
      const r = await fetch(`${API_BASE}/api/dashboard/stats`);
      if (r.ok) {
        const data = await r.json();
        // API tem prioridade se retornar dados válidos
        if (data.totalRevenueMonth !== undefined) {
          document.getElementById('revenueValue').textContent = currencyBRL(data.totalRevenueMonth);
        }
        if (data.newAppointmentsMonth !== undefined) {
          document.getElementById('appointmentsValue').textContent = data.newAppointmentsMonth;
        }
        if (data.activeBarbers !== undefined) {
          document.getElementById('barbersValue').textContent = data.activeBarbers;
        }
      }
    } catch (e) {
      console.log('[STATS] API indisponível, usando dados locais');
    }
  }

  function statusBadge(status) {
    const map = {
      'Pago': 'bg-green-600',
      'Pendente': 'bg-yellow-600',
      'Cancelado': 'bg-red-600'
    };
    const cls = map[status] || 'bg-gray-600';
    return `<span class="${cls} text-white text-xs font-medium px-2.5 py-0.5 rounded-full">${status}</span>`;
  }

  function formatDateBR(iso) {
    if (!iso) return '';
    const [y,m,d] = iso.split('-');
    return `${d}/${m}/${y}`;
  }

  async function loadRecent() {
    const tbody = document.getElementById('recentTbody');
    if (!tbody) return;
    
    try {
      console.log('[LOAD_RECENT] Iniciando carregamento...');
      
      // Tenta carregar da API primeiro
      let bookings = [];
      try {
        const r = await fetch(`${API_BASE}/api/dashboard/recent-appointments?limit=3`);
        if (r.ok) {
          const data = await r.json();
          bookings = data.bookings || [];
          console.log('[LOAD_RECENT] Carregado da API:', bookings.length);
        }
      } catch (apiError) {
        console.warn('[LOAD_RECENT] API indisponível, usando localStorage');
      }
      
      // Fallback: localStorage
      if (bookings.length === 0) {
        const stored = localStorage.getItem('bookings');
        if (stored) {
          const allBookings = JSON.parse(stored);
          // Ordena por data/hora mais recente e pega os 3 primeiros
          bookings = allBookings
            .sort((a, b) => {
              const dateA = new Date(`${a.dataISO || a.data}T${a.hora}`);
              const dateB = new Date(`${b.dataISO || b.data}T${b.hora}`);
              return dateB - dateA; // Mais recente primeiro
            })
            .slice(0, 3);
          console.log('[LOAD_RECENT] Carregado do localStorage:', bookings.length);
        }
      }
      
      if (!bookings || bookings.length === 0) {
        tbody.innerHTML = `<tr><td class="px-6 py-4 text-gray-400" colspan="6">Sem agendamentos recentes</td></tr>`;
        return;
      }
      
      // Mostra apenas os últimos 3 agendamentos
      const recentBookings = bookings.slice(0, 3);
      tbody.innerHTML = recentBookings.map(b => `
        <tr class="bg-[#2A2A2A] border-b border-gray-700 hover:bg-gray-700 transition-colors duration-200">
          <td class="px-6 py-4 font-medium text-white whitespace-nowrap">${b.cliente || b.clientName || 'N/A'}</td>
          <td class="px-6 py-4">${b.barbeiro || 'Equipe'}</td>
          <td class="px-6 py-4">${formatDateBR(b.dataISO || b.data)}</td>
          <td class="px-6 py-4">${b.servicoNome || b.servico || 'N/A'}</td>
          <td class="px-6 py-4">${b.hora}</td>
          <td class="px-6 py-4">${statusBadge(b.status || 'Pendente')}</td>
        </tr>
      `).join('');
      
      console.log('[LOAD_RECENT] Agendamentos renderizados com sucesso');
    } catch (e) {
      console.error('[LOAD_RECENT] Erro ao carregar:', e);
      tbody.innerHTML = `<tr><td class="px-6 py-4 text-red-400" colspan="6">Erro ao carregar agendamentos</td></tr>`;
    }
  }

  let monthlyGoalChart;
  function renderMonthlyGoalChart() {
    try {
      const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
      const goals = JSON.parse(localStorage.getItem('financeGoals') || '{"revenue": 10000, "clients": 50, "bookings": 100}');
      
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const currentDay = now.getDate();
      
      // Filtrar agendamentos do mês atual
      const monthBookings = bookings.filter(b => {
        const bookingDate = new Date(b.dataISO || b.data);
        return bookingDate.getMonth() === currentMonth && 
               bookingDate.getFullYear() === currentYear &&
               b.status !== 'Cancelado';
      });
      
      // Agrupar receita por dia
      const dailyRevenue = {};
      monthBookings.forEach(b => {
        const date = new Date(b.dataISO || b.data);
        const day = date.getDate();
        dailyRevenue[day] = (dailyRevenue[day] || 0) + (parseFloat(b.valor) || 0);
      });
      
      // Criar arrays para o gráfico
      const labels = [];
      const actualData = [];
      const goalData = [];
      const projectionData = [];
      
      let cumulativeRevenue = 0;
      const dailyGoal = goals.revenue / daysInMonth;
      
      for (let day = 1; day <= daysInMonth; day++) {
        labels.push(day);
        
        // Receita acumulada real
        if (day <= currentDay) {
          cumulativeRevenue += (dailyRevenue[day] || 0);
          actualData.push(cumulativeRevenue);
        } else {
          actualData.push(null);
        }
        
        // Linha da meta (linear)
        goalData.push(dailyGoal * day);
        
        // Projeção (baseada na média diária atual)
        if (day > currentDay) {
          const avgDaily = cumulativeRevenue / currentDay;
          projectionData.push(avgDaily * day);
        } else {
          projectionData.push(null);
        }
      }
      
      // Calcular porcentagem da meta
      const goalPercent = Math.min(100, Math.round((cumulativeRevenue / goals.revenue) * 100));
      document.getElementById('goalProgressPercent').textContent = `${goalPercent}%`;
      document.getElementById('goalProgressLabel').textContent = `R$ ${cumulativeRevenue.toFixed(0)} / R$ ${goals.revenue.toFixed(0)}`;
      
      // Criar gráfico
      const ctx = document.getElementById('monthlyGoalChart');
      if (!ctx) return;
      
      if (monthlyGoalChart) monthlyGoalChart.destroy();
      
      monthlyGoalChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Meta',
              data: goalData,
              borderColor: '#f59e0b',
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              borderWidth: 2,
              borderDash: [5, 5],
              fill: false,
              pointRadius: 0,
              tension: 0
            },
            {
              label: 'Real',
              data: actualData,
              borderColor: '#06b6d4',
              backgroundColor: 'rgba(6, 182, 212, 0.3)',
              borderWidth: 3,
              fill: true,
              pointRadius: 0,
              tension: 0.4
            },
            {
              label: 'Projeção',
              data: projectionData,
              borderColor: '#ec4899',
              backgroundColor: 'rgba(236, 72, 153, 0.2)',
              borderWidth: 2,
              fill: true,
              pointRadius: 0,
              tension: 0.4,
              borderDash: [3, 3]
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: '#9CA3AF',
                font: { size: 11 },
                padding: 10,
                usePointStyle: true
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.dataset.label || '';
                  const value = context.parsed.y || 0;
                  return `${label}: R$ ${value.toFixed(2)}`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { 
                color: '#9CA3AF',
                maxTicksLimit: 10
              },
              grid: { 
                color: 'rgba(255,255,255,0.05)'
              }
            },
            y: {
              ticks: { 
                color: '#9CA3AF',
                callback: function(value) {
                  return 'R$ ' + value.toFixed(0);
                }
              },
              grid: { 
                color: 'rgba(255,255,255,0.1)'
              }
            }
          }
        }
      });
      
    } catch (e) {
      console.error('Erro ao renderizar gráfico de meta mensal:', e);
    }
  }

  // Top Clients Chart
  let topClientsChart;
  function renderTopClientsChart() {
    try {
      const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      // Filtrar agendamentos do mês atual (não cancelados)
      const monthBookings = bookings.filter(b => {
        const bookingDate = new Date(b.dataISO || b.data);
        return bookingDate.getMonth() === currentMonth && 
               bookingDate.getFullYear() === currentYear && 
               b.status !== 'Cancelado';
      });
      
      // Agrupar por cliente
      const clientCounts = {};
      monthBookings.forEach(b => {
        const clientName = b.cliente || b.telefone || 'Cliente';
        clientCounts[clientName] = (clientCounts[clientName] || 0) + 1;
      });
      
      // Ordenar e pegar top 7 clientes
      const topClients = Object.entries(clientCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 7);
      
      // Se não houver dados
      if (topClients.length === 0) {
        const legendDiv = document.getElementById('topClientsLegend');
        if (legendDiv) {
          legendDiv.innerHTML = '<p class="text-gray-400 text-center col-span-2">Nenhum cliente no mês atual</p>';
        }
        return;
      }
      
      const labels = topClients.map(([name]) => name);
      const data = topClients.map(([, count]) => count);
      const total = data.reduce((sum, val) => sum + val, 0);
      
      // Cores modernas (azuis, cyans, verdes, roxos, rosas)
      const colors = [
        '#2563eb', // blue-600
        '#06b6d4', // cyan-500
        '#14b8a6', // teal-500
        '#10b981', // emerald-500
        '#8b5cf6', // violet-500
        '#ec4899', // pink-500
        '#f59e0b'  // amber-500
      ];
      
      // Criar gráfico
      const ctx = document.getElementById('topClientsChart').getContext('2d');
      if (topClientsChart) topClientsChart.destroy();
      
      topClientsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, topClients.length),
            borderColor: '#2A2A2A',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value} visitas (${percentage}%)`;
                }
              }
            }
          }
        }
      });
      
      // Criar legenda customizada
      const legendDiv = document.getElementById('topClientsLegend');
      if (legendDiv) {
        legendDiv.innerHTML = topClients.map(([name, count], index) => {
          const percentage = ((count / total) * 100).toFixed(1);
          return `
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 rounded-full" style="background-color: ${colors[index]}"></div>
              <span class="text-gray-300 truncate flex-1">${name}</span>
              <span class="text-gray-400 font-semibold">${percentage}%</span>
            </div>
          `;
        }).join('');
      }
      
    } catch (e) {
      console.error('Erro ao renderizar gráfico de clientes:', e);
    }
  }


  // Boot
  (function init() {
    // Inicializar menu mobile
    initMobileMenu();
    
    const isAuth = sessionStorage.getItem('admin_authenticated');
    const authTime = sessionStorage.getItem('admin_auth_time');
    const now = Date.now();
    const fourHours = 4 * 60 * 60 * 1000;
    const valid = isAuth && authTime && ((now - parseInt(authTime)) <= fourHours);
    if (valid) {
      loadStats();
      loadRecent();
      renderMonthlyGoalChart();
      renderTopClientsChart();
    }
  })();

  // Refresh function
  function refreshDashboard() {
    loadStats();
    loadRecent();
    renderMonthlyGoalChart();
    renderTopClientsChart();
  }

  // Logout function
  function logout() {
    sessionStorage.removeItem('admin_authenticated');
    sessionStorage.removeItem('admin_auth_time');
    window.location.href = 'index.html';
  }

  // ==============
  // Mobile Menu
  // ==============
  function initMobileMenu() {
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const closeSidebarBtn = document.getElementById('closeSidebarBtn');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobileOverlay');

    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      overlay.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeSidebar() {
      sidebar.classList.add('-translate-x-full');
      overlay.classList.add('hidden');
      document.body.style.overflow = '';
    }

    if (mobileMenuBtn) {
      mobileMenuBtn.addEventListener('click', openSidebar);
    }

    if (closeSidebarBtn) {
      closeSidebarBtn.addEventListener('click', closeSidebar);
    }

    if (overlay) {
      overlay.addEventListener('click', closeSidebar);
    }

    // Fechar sidebar ao clicar em qualquer item do menu
    const navButtons = document.querySelectorAll('#sidebarNav button[data-view]');
    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        if (window.innerWidth < 1024) { // lg breakpoint
          closeSidebar();
        }
      });
    });
  }

  // ==============
  // Views handling
  // ==============
  function bindNavDW(){
    const nav = document.getElementById('sidebarNav');
    if (!nav || bindNavDW._bound) return; bindNavDW._bound = true;
    nav.querySelectorAll('button[data-view]').forEach(btn => {
      btn.addEventListener('click', () => {
        const view = btn.getAttribute('data-view');
        switchViewDW(view);
        nav.querySelectorAll('button[data-view]').forEach(b => b.classList.remove('bg-[#A38F5F]/20','text-[#A38F5F]'));
        btn.classList.add('bg-[#A38F5F]/20','text-[#A38F5F]');
      });
    });
  }

  function switchViewDW(view){
    const ids = ['view-dashboard','view-orders','view-clients','view-settings','view-services','view-barbers','view-finance'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      if (id === `view-${view}`) el.classList.remove('hidden'); else el.classList.add('hidden');
    });
    if (view === 'orders') loadOrdersDW();
    if (view === 'clients') loadClientsDW();
    if (view === 'settings') initSettingsDW();
    if (view === 'services') loadServicesDW();
    if (view === 'barbers') loadBarbersDW();
    if (view === 'finance') loadFinanceViewDW();
  }

  // ==============
  // Orders (Vendas)
  // ==============
  async function fetchAllBookingsDW(params = {}){
    // Tenta API primeiro
    try {
      const url = new URL(`${API_BASE}/api/bookings`);
      Object.entries(params).forEach(([k,v]) => { if (v != null && v !== '' && v !== 'all') url.searchParams.set(k,v); });
      const r = await fetch(url.toString());
      const data = await r.json().catch(()=>({}));
      if (r.ok && Array.isArray(data.bookings)) {
        console.log('[FETCH_BOOKINGS] Carregado da API:', data.bookings.length);
        return data.bookings;
      }
    } catch(e) {
      console.warn('[FETCH_BOOKINGS] API indisponível:', e.message);
    }
    
    // Fallback: localStorage
    try {
      const stored = localStorage.getItem('bookings');
      if (stored) {
        const bookings = JSON.parse(stored);
        console.log('[FETCH_BOOKINGS] Carregado do localStorage:', bookings.length);
        return Array.isArray(bookings) ? bookings : [];
      }
    } catch(e) {
      console.error('[FETCH_BOOKINGS] Erro ao ler localStorage:', e);
    }
    
    console.warn('[FETCH_BOOKINGS] Nenhum agendamento encontrado');
    return [];
  }

  function formatBRLDW(v){
    try { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(Number(v)||0); } catch { return `R$ ${(Number(v)||0).toFixed(2)}`; }
  }

  function statusBadgeDW(status){
    const map = { 'Pago': 'bg-green-600', 'Pendente': 'bg-yellow-600', 'Cancelado': 'bg-red-600' };
    const cls = map[status] || 'bg-gray-600';
    return `<span class="${cls} text-white text-xs font-medium px-2.5 py-0.5 rounded-full">${status}</span>`;
  }

  async function updateOrderStatusDW(id, newStatus){
    try{
      const r = await fetch(`${API_BASE}/api/bookings/${id}/status`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ status: newStatus }) });
      if (!r.ok) throw new Error('Falha ao atualizar status');
      toastDW('Status atualizado');
      loadOrdersDW();
    }catch(e){ toastDW('Erro ao atualizar status','error'); }
  }

  let ordersCacheDW = [];
  async function loadOrdersDW(){
    const tbody = document.getElementById('ordersTbodyDW');
    if (!tbody) return;
    
    // Resetar filtro para mostrar TODOS os agendamentos
    const filterSelect = document.getElementById('ordersStatusFilter');
    if (filterSelect) filterSelect.value = 'all';
    
    // Limpar busca
    const searchInput = document.getElementById('ordersSearch');
    if (searchInput) searchInput.value = '';
    
    tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-gray-400">Carregando...</td></tr>`;
    
    try{
      ordersCacheDW = await fetchAllBookingsDW();
      console.log('[ORDERS] Carregados', ordersCacheDW.length, 'agendamentos');
    }catch(e){ 
      console.error('[ORDERS] Erro ao carregar:', e);
      ordersCacheDW = []; 
    }
    
    renderOrdersDW();
    
    const f = document.getElementById('ordersStatusFilter');
    const s = document.getElementById('ordersSearch');
    if (f && !f._bound){ f._bound = true; f.addEventListener('change', renderOrdersDW); }
    if (s && !s._bound){ s._bound = true; s.addEventListener('input', renderOrdersDW); }
  }

  function renderOrdersDW(){
    const tbody = document.getElementById('ordersTbodyDW');
    if (!tbody) return;
    
    const status = (document.getElementById('ordersStatusFilter')?.value)||'all';
    const q = (document.getElementById('ordersSearch')?.value||'').toLowerCase();
    
    console.log('[RENDER_ORDERS] Status filtro:', status, 'Busca:', q, 'Total cache:', ordersCacheDW.length);
    
    const data = ordersCacheDW.filter(o => (status==='all'||o.status===status) && JSON.stringify(o).toLowerCase().includes(q));
    
    console.log('[RENDER_ORDERS] Após filtro:', data.length, 'agendamentos');
    
    if (!data.length){ 
      tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-gray-400">Sem agendamentos encontrados</td></tr>`; 
      return; 
    }
    
    tbody.innerHTML = data.map(o=>{
      const d = o.dataISO ? o.dataISO : o.data;
      const br = d ? `${d.split('-').reverse().join('/')}` : '-';
      const actions = o.status==='Pendente' ? `
        <div class="flex gap-2">
          <button class="px-2 py-1 rounded bg-emerald-600 text-white text-xs" onclick="updateOrderStatusDW(${o.id}, 'Pago')">Confirmar</button>
          <button class="px-2 py-1 rounded bg-red-600 text-white text-xs" onclick="updateOrderStatusDW(${o.id}, 'Cancelado')">Cancelar</button>
        </div>` : '<span class="text-gray-500 text-xs">—</span>';
      return `
        <tr class="bg-[#2A2A2A] border-b border-gray-700">
          <td class="px-6 py-3">#${o.id}</td>
          <td class="px-6 py-3">${o.cliente||'-'}</td>
          <td class="px-6 py-3">${o.servicoNome||o.servico||'-'}</td>
          <td class="px-6 py-3">${formatBRLDW(o.valor)}</td>
          <td class="px-6 py-3">${br}</td>
          <td class="px-6 py-3">${statusBadgeDW(o.status||'-')}</td>
          <td class="px-6 py-3">${actions}</td>
        </tr>`;
    }).join('');
  }

  // ==========
  // Clients
  // ==========
  let clientsCacheDW = [];
  async function loadClientsDW(){
    // usa ordersCache se já carregado
    if (!ordersCacheDW.length){
      try{ ordersCacheDW = await fetchAllBookingsDW(); }catch(e){ ordersCacheDW=[]; }
    }
    const map = {};
    ordersCacheDW.forEach(b=>{
      const tel = (b.telefone||'').replace(/\D/g,''); if (!tel) return;
      if (!map[tel]) map[tel] = { nome: b.cliente||'-', telefone: tel, lastVisit: b.dataISO||b.data, totalSpent:0, bookingCount:0 };
      map[tel].totalSpent += Number(b.valor)||0;
      map[tel].bookingCount += 1;
      if ((b.dataISO||b.data) > map[tel].lastVisit) map[tel].lastVisit = (b.dataISO||b.data);
    });
    clientsCacheDW = Object.values(map);
    renderClientsDW();
    const s = document.getElementById('clientSearchDW'); if (s && !s._bound){ s._bound=true; s.addEventListener('input', renderClientsDW); }
  }

  function renderClientsDW(){
    const tbody = document.getElementById('clientsTbodyDW'); if (!tbody) return;
    const q = (document.getElementById('clientSearchDW')?.value||'').toLowerCase();
    let list = clientsCacheDW.filter(c => c.nome.toLowerCase().includes(q) || c.telefone.includes(q));
    if (!list.length){ tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-gray-400">Nenhum cliente encontrado</td></tr>`; return; }
    list.sort((a,b)=> (b.lastVisit||'').localeCompare(a.lastVisit||''));
    tbody.innerHTML = list.map(c=>`
      <tr class="bg-[#2A2A2A] border-b border-gray-700">
        <td class="px-6 py-3">${c.nome}</td>
        <td class="px-6 py-3">${c.telefone}</td>
        <td class="px-6 py-3">${c.lastVisit? c.lastVisit.split('-').reverse().join('/'):'-'}</td>
        <td class="px-6 py-3">${formatBRLDW(c.totalSpent)}</td>
        <td class="px-6 py-3">${c.bookingCount}</td>
      </tr>`).join('');
  }

  // ==============
  // Settings
  // ==============
  let settingsBoundDW = false;
  function initSettingsDW(){
    if (settingsBoundDW) { // ainda assim atualiza listas
      renderAvailableSlotsListDW();
      renderWeeklyCalendarDW();
      renderClosedDatesDW();
      loadActiveBarbersDW();
      return;
    }
    // bind
    const sel = document.getElementById('slotDaySelectDW');
    if (sel && !sel._bound){ sel._bound=true; sel.addEventListener('change', ()=>{ renderAvailableSlotsListDW(); }); }
    settingsBoundDW = true;
    // carrega
    loadActiveBarbersDW();
    renderAvailableSlotsListDW();
    renderWeeklyCalendarDW();
    renderClosedDatesDW();
  }

  // Equipe
  async function loadActiveBarbersDW(){
    const input = document.getElementById('activeBarbersInputDW');
    console.log('[LOAD_BARBERS] Carregando barbeiros ativos...', { input });
    
    if (!input) {
      console.error('[LOAD_BARBERS] Input não encontrado!');
      return;
    }

    // SEMPRE sincronizar com a lista real de barbeiros
    try {
      const barbersStored = localStorage.getItem('barbers');
      if (barbersStored) {
        const barbers = JSON.parse(barbersStored);
        const activeCount = barbers.filter(b => b.active).length;
        localStorage.setItem('active_barbers', activeCount.toString());
        input.value = activeCount;
        console.log('[LOAD_BARBERS] Sincronizado com lista de barbeiros:', activeCount);
        return;
      }
    } catch (e) {
      console.error('[LOAD_BARBERS] Erro ao sincronizar com barbeiros:', e);
    }

    // Se não tem barbeiros cadastrados, carrega do localStorage antigo
    try {
      const stored = localStorage.getItem('active_barbers');
      console.log('[LOAD_BARBERS] localStorage value:', stored);
      
      if (stored != null) {
        const n = parseInt(stored, 10);
        if (!isNaN(n) && n >= 0) {
          input.value = n;
          console.log('[LOAD_BARBERS] Carregado do localStorage:', n);
          return;
        }
      }
    } catch (e) {
      console.error('[LOAD_BARBERS] Erro ao ler localStorage:', e);
    }

    // Se não tem no localStorage, tenta API
    try {
      console.log('[LOAD_BARBERS] Tentando carregar da API...');
      const r = await fetch(`${API_BASE}/api/settings/active_barbers`);
      const data = await r.json();
      
      if (data && data.value != null){ 
        const n = parseInt(data.value,10); 
        if (!isNaN(n) && n >= 0) {
          input.value = n;
          // Salva no localStorage também
          localStorage.setItem('active_barbers', String(n));
          console.log('[LOAD_BARBERS] Carregado da API:', n);
        }
      }
    } catch (e) {
      console.warn('[LOAD_BARBERS] API não disponível:', e.message);
      // Deixa valor padrão 0
      input.value = 0;
    }
  }
  
  async function saveActiveBarbersDW(){
    const input = document.getElementById('activeBarbersInputDW');
    const status = document.getElementById('activeBarbersStatusDW');
    const value = parseInt(input?.value||'0',10);
    
    console.log('[SAVE_BARBERS] Iniciando save...', { input, status, value });
    
    if (!input || isNaN(value)) {
      console.error('[SAVE_BARBERS] Input inválido ou valor NaN');
      if (status) status.textContent = '❌ Valor inválido';
      return;
    }

    // Sempre salvar no localStorage como fallback
    try {
      localStorage.setItem('active_barbers', String(value));
      console.log('[SAVE_BARBERS] Salvo no localStorage:', value);
    } catch (e) {
      console.error('[SAVE_BARBERS] Erro ao salvar no localStorage:', e);
    }

    // Tentar salvar na API
    try {
      console.log('[SAVE_BARBERS] Tentando salvar na API...', API_BASE);
      const r = await fetch(`${API_BASE}/api/settings/active_barbers`, { 
        method:'PUT', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({ value }) 
      });
      
      console.log('[SAVE_BARBERS] Resposta da API:', r.status, r.ok);
      
      if (r.ok) {
        if (status) {
          status.textContent = '✓ Salvo com sucesso!';
          status.style.color = '#00ff41';
        }
        toastDW('Barbeiros ativos atualizado!');
        console.log('[SAVE_BARBERS] Sucesso!');
      } else {
        throw new Error('Erro na API: ' + r.status);
      }
    } catch (err) {
      // Salvou no localStorage mesmo sem API
      console.warn('[SAVE_BARBERS] API indisponível, usando localStorage:', err.message);
      if (status) {
        status.textContent = '✓ Salvo localmente';
        status.style.color = '#00d4ff';
      }
      toastDW('Salvo localmente (sem backend)');
    }

    // Recarregar valor para garantir que aparece
    console.log('[SAVE_BARBERS] Recarregando valor na tela...');
    await loadActiveBarbersDW();

    // Limpar mensagem após 3s
    setTimeout(() => {
      if (status) status.textContent = '';
    }, 3000);
  }

  // Slots helpers (localStorage)
  const DEFAULT_SLOTS_DW = ['09:00','09:30','10:00','10:30','11:00','11:30','14:00','14:30','15:00','15:30','16:00','16:30'];
  function toMinutesDW(hhmm){ const [h,m]=(hhmm||'').split(':').map(Number); return (Number.isFinite(h)&&Number.isFinite(m))?(h*60+m):0; }
  function getAvailableSlotsDW(){ try{ const raw=JSON.parse(localStorage.getItem('availableSlots')||'null'); let arr=Array.isArray(raw)?raw.filter(v=>/^([01]\d|2[0-3]):[0-5]\d$/.test(v)):null; if (!arr||!arr.length) arr=DEFAULT_SLOTS_DW.slice(); return Array.from(new Set(arr)).sort((a,b)=>toMinutesDW(a)-toMinutesDW(b)); }catch{return DEFAULT_SLOTS_DW.slice();} }
  function saveAvailableSlotsDW(slots){ try{ localStorage.setItem('availableSlots', JSON.stringify(slots)); }catch{} }
  function getSlotsByDayDW(){ try{ const obj=JSON.parse(localStorage.getItem('availableSlotsByDay')||'null'); return (obj && typeof obj==='object')?obj:{}; }catch{return{}} }
  function saveSlotsByDayDW(map){ try{ localStorage.setItem('availableSlotsByDay', JSON.stringify(map)); }catch{} }
  function getSlotsForDowDW(dowStr){ const map=getSlotsByDayDW(); const arr=(map && Array.isArray(map[dowStr]))?map[dowStr]:[]; if (arr&&arr.length) return Array.from(new Set(arr)).filter(v=>/^([01]\d|2[0-3]):[0-5]\d$/.test(v)).sort((a,b)=>toMinutesDW(a)-toMinutesDW(b)); return getAvailableSlotsDW(); }
  function setSlotsForDowDW(dowStr, slots){ const map=getSlotsByDayDW(); map[dowStr]=Array.from(new Set(slots)).filter(v=>/^([01]\d|2[0-3]):[0-5]\d$/.test(v)).sort((a,b)=>toMinutesDW(a)-toMinutesDW(b)); saveSlotsByDayDW(map); }

  function renderAvailableSlotsListDW(){ const list=document.getElementById('availableSlotsListDW'); if (!list) return; const sel=document.getElementById('slotDaySelectDW'); const dow = sel?String(sel.value):String(new Date().getDay()); const slots=getSlotsForDowDW(dow); list.innerHTML=''; if (!slots.length){ list.innerHTML='<div class="text-gray-400">Nenhum horário configurado</div>'; return; } slots.forEach(s=>{ const row=document.createElement('div'); row.className='flex items-center gap-2 border border-gray-700 rounded-md px-2 py-1'; row.innerHTML = `<span>${s}</span>`; const eBtn=document.createElement('button'); eBtn.className='px-2 py-1 text-xs border border-gray-700 rounded hover:bg-gray-700'; eBtn.innerHTML='<i>Editar</i>'; eBtn.onclick=()=>editAvailableSlotDW(s); const dBtn=document.createElement('button'); dBtn.className='px-2 py-1 text-xs border border-gray-700 rounded hover:bg-gray-700'; dBtn.innerHTML='<i>Remover</i>'; dBtn.onclick=()=>removeAvailableSlotDWDow(s); const dAllBtn=document.createElement('button'); dAllBtn.className='px-2 py-1 text-xs border border-red-700 text-red-300 rounded hover:bg-red-900/30'; dAllBtn.innerHTML='<i>Remover (todos)</i>'; dAllBtn.onclick=()=>removeAvailableSlotDWAll(s); row.appendChild(eBtn); row.appendChild(dBtn); row.appendChild(dAllBtn); list.appendChild(row); }); }

  function addAvailableSlotDW(){ const input=document.getElementById('newSlotInputDW'); if (!input) return; let v=(input.value||'').trim(); if (/^\d{1,2}:\d{2}$/.test(v)){ const [h,m]=v.split(':').map(n=>String(n).padStart(2,'0')); v=`${h}:${m}`; } if (!/^([01]\d|2[0-3]):[0-5]\d$/.test(v)) { toastDW('Informe um horário válido (HH:MM)','error'); return; } const sel=document.getElementById('slotDaySelectDW'); const dow= sel?String(sel.value):String(new Date().getDay()); let slots=getSlotsByDayDW()[dow] || getSlotsForDowDW(dow); if (slots.includes(v)) { toastDW('Horário já existe','error'); return; } slots=[...slots,v]; const sorted=Array.from(new Set(slots)).sort((a,b)=>toMinutesDW(a)-toMinutesDW(b)); setSlotsForDowDW(dow, sorted); renderAvailableSlotsListDW(); renderWeeklyCalendarDW(); }
  function addAvailableSlotToAllDaysDW(){ const input=document.getElementById('newSlotInputDW'); if (!input) return; let v=(input.value||'').trim(); if (/^\d{1,2}:\d{2}$/.test(v)){ const [h,m]=v.split(':').map(n=>String(n).padStart(2,'0')); v=`${h}:${m}`; } if (!/^([01]\d|2[0-3]):[0-5]\d$/.test(v)) { toastDW('Informe um horário válido (HH:MM)','error'); return; } if (!confirm(`Adicionar ${v} em todos os dias (Dom–Sáb)?`)) return; for (let dow=0; dow<=6; dow++){ let slots=getSlotsByDayDW()[String(dow)] || getSlotsForDowDW(String(dow)); if (!slots.includes(v)){ slots=[...slots,v]; setSlotsForDowDW(String(dow), Array.from(new Set(slots)).sort((a,b)=>toMinutesDW(a)-toMinutesDW(b))); } } renderAvailableSlotsListDW(); renderWeeklyCalendarDW(); }
  function removeAvailableSlotDWDow(v){ const sel=document.getElementById('slotDaySelectDW'); const dow= sel?String(sel.value):String(new Date().getDay()); let slots=getSlotsByDayDW()[dow] || getSlotsForDowDW(dow); slots = slots.filter(s=>s!==v); setSlotsForDowDW(dow, slots); renderAvailableSlotsListDW(); renderWeeklyCalendarDW(); }
  function removeAvailableSlotDWAll(v){ if (!confirm(`Remover ${v} de todos os dias?`)) return; for (let dow=0; dow<=6; dow++){ let slots=getSlotsByDayDW()[String(dow)] || getSlotsForDowDW(String(dow)); const oldLen=slots.length; slots=slots.filter(s=>s!==v); if (slots.length<oldLen) setSlotsForDowDW(String(dow), slots); } renderAvailableSlotsListDW(); renderWeeklyCalendarDW(); }
  function editAvailableSlotDW(oldV){ const current=(oldV||'').trim(); const input=prompt('Novo horário (HH:MM):', current); if (input==null) return; let v=input.trim(); if (/^\d{1,2}:\d{2}$/.test(v)){ const [h,m]=v.split(':').map(n=>String(n).padStart(2,'0')); v=`${h}:${m}`; } if (!/^([01]\d|2[0-3]):[0-5]\d$/.test(v)) { toastDW('Informe um horário válido (HH:MM)','error'); return; } const sel=document.getElementById('slotDaySelectDW'); const dow= sel?String(sel.value):String(new Date().getDay()); let slots=getSlotsByDayDW()[dow] || getSlotsForDowDW(dow); if (v===current) return; if (slots.includes(v)) { toastDW('Este horário já existe','error'); return; } slots=slots.map(s=> s===current? v : s); slots=Array.from(new Set(slots)).sort((a,b)=>toMinutesDW(a)-toMinutesDW(b)); setSlotsForDowDW(dow, slots); renderAvailableSlotsListDW(); renderWeeklyCalendarDW(); }
  function generateTimeArrayDW(startHHMM,endHHMM,stepMin){ const [sh,sm]=startHHMM.split(':').map(Number); const [eh,em]=endHHMM.split(':').map(Number); const start=sh*60+sm; const end=eh*60+em; const step=Number(stepMin)||30; if (!Number.isFinite(start)||!Number.isFinite(end)||step<5||end<start) return []; const out=[]; for (let t=start;t<=end;t+=step){ const h=Math.floor(t/60), m=t%60; out.push(String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')); } return out; }
  function generateForSelectedDayDW(){ const sel=document.getElementById('slotDaySelectDW'); const dow= sel?String(sel.value):String(new Date().getDay()); const s=document.getElementById('genStartDWW')?.value||'09:00'; const e=document.getElementById('genEndDW')?.value||'18:00'; const p=Number(document.getElementById('genStepDW')?.value||30); const arr=generateTimeArrayDW(s,e,p); if (!arr.length){ toastDW('Parâmetros inválidos','error'); return; } setSlotsForDowDW(dow, arr); renderAvailableSlotsListDW(); renderWeeklyCalendarDW(); }
  function applyPresetTueFriSatDW(){ const tueFri=generateTimeArrayDW('09:00','18:00',30); const sat=generateTimeArrayDW('09:00','16:00',30); ['2','3','4','5'].forEach(d=> setSlotsForDowDW(d, tueFri)); setSlotsForDowDW('6', sat); renderAvailableSlotsListDW(); renderWeeklyCalendarDW(); }
  
  function copySlotsFromDayDW(){ const sel=document.getElementById('slotDaySelectDW'); const targetDow= sel?String(sel.value):String(new Date().getDay()); const mapNames=['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado']; const from=prompt('Copiar horários de qual dia? (0=Dom,1=Seg,2=Ter,3=Qua,4=Qui,5=Sex,6=Sáb)', '1'); if (from==null) return; const srcDow=String(parseInt(from,10)); if (!/^([0-6])$/.test(srcDow)){ toastDW('Dia inválido','error'); return; } const slots=getSlotsForDowDW(srcDow); setSlotsForDowDW(targetDow, slots); renderAvailableSlotsListDW(); renderWeeklyCalendarDW(); toastDW('Horários copiados de '+mapNames[Number(srcDow)]); }
  
  function useGlobalDefaultSlotsDW(){ const sel=document.getElementById('slotDaySelectDW'); const dow= sel?String(sel.value):String(new Date().getDay()); const slots=getAvailableSlotsDW(); setSlotsForDowDW(dow, slots); renderAvailableSlotsListDW(); renderWeeklyCalendarDW(); toastDW('Aplicado o padrão global'); }

  function toggleWeeklyCalendarDW(){ const view=document.getElementById('weeklyCalendarViewDW'); const btn=document.getElementById('toggleCalendarBtnDW'); if (!view||!btn) return; const isVisible = !view.classList.contains('hidden'); if (isVisible){ view.classList.add('hidden'); btn.textContent='Ver calendário semanal'; } else { view.classList.remove('hidden'); btn.textContent='Fechar calendário'; renderWeeklyCalendarDW(); } }
  function renderWeeklyCalendarDW(){ const grid=document.getElementById('weeklyCalendarGridDW'); if (!grid) return; const dayNames=['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado']; const dayIcons=['☀️','💼','💼','💼','💼','💼','🎉']; grid.innerHTML=''; for (let dow=0; dow<=6; dow++){ const slots=getSlotsForDowDW(String(dow)); const card=document.createElement('div'); card.className='p-3 rounded-lg border border-gray-700 bg-[#1A1A1A]'; const head=document.createElement('div'); head.className='font-semibold text-[#A38F5F] mb-2'; head.textContent=`${dayIcons[dow]} ${dayNames[dow]}`; const body=document.createElement('div'); body.className='text-sm text-gray-300'; if (!slots.length){ body.innerHTML='<div class="text-gray-500 italic">Sem horários</div>'; } else { const summary = slots.length <= 5 ? slots.join(', ') : `${slots[0]} - ${slots[slots.length-1]} (${slots.length} horários)`; body.innerHTML = `<div class="font-semibold mb-1">${slots.length} horário(s)</div><div>${summary}</div>`; const edit=document.createElement('button'); edit.className='mt-2 w-full px-2 py-1 rounded border border-gray-700 hover:bg-gray-700 text-xs'; edit.textContent='Editar'; edit.onclick=()=>{ const sel=document.getElementById('slotDaySelectDW'); if (sel) sel.value=String(dow); renderAvailableSlotsListDW(); sel?.scrollIntoView({behavior:'smooth', block:'center'}); }; body.appendChild(edit); }
      card.appendChild(head); card.appendChild(body); grid.appendChild(card); }
  }

  // Dias Fechados
  function renderClosedDatesDW(){ const list=document.getElementById('closedDatesListDW'); if (!list) return; let closed=[]; try{ closed=JSON.parse(localStorage.getItem('closedDates')||'[]'); }catch{} const hasSunday=closed.some(dateISO=> new Date(dateISO+'T12:00:00').getDay()===0); const hasMonday=closed.some(dateISO=> new Date(dateISO+'T12:00:00').getDay()===1); const sb=document.getElementById('sundayBtnTextDW'); if (sb) sb.textContent = hasSunday ? 'Reabrir todos os domingos' : 'Fechar todos os domingos'; const mb=document.getElementById('mondayBtnTextDW'); if (mb) mb.textContent = hasMonday ? 'Reabrir todas as segundas' : 'Fechar todas as segundas'; if (!closed.length){ list.innerHTML='<div class="text-center text-gray-400 py-4">Nenhuma data fechada</div>'; return; } list.innerHTML=''; closed.forEach(dateISO=>{ const row=document.createElement('div'); row.className='flex items-center justify-between border border-gray-700 rounded px-3 py-2'; const dbr = dateISO.split('-').reverse().join('/'); const day = new Date(dateISO+'T12:00:00').toLocaleDateString('pt-BR',{weekday:'long'}); row.innerHTML = `<div><div class="font-semibold">${dbr}</div><div class="text-xs text-gray-400 capitalize">${day}</div></div>`; const del=document.createElement('button'); del.className='px-3 py-1 rounded border border-red-700 text-red-300 hover:bg-red-900/30 text-sm'; del.textContent='Remover'; del.onclick=()=>removeClosedDateDW(dateISO); row.appendChild(del); list.appendChild(row); }); }
  function addClosedDateDW(){ const input=document.getElementById('closedDateInputDW'); const v=input?.value; if (!v){ toastDW('Selecione uma data','error'); return;} try{ let list=JSON.parse(localStorage.getItem('closedDates')||'[]'); if (list.includes(v)){ toastDW('Data já existente','error'); return; } list.push(v); list.sort(); localStorage.setItem('closedDates', JSON.stringify(list)); input.value=''; renderClosedDatesDW(); toastDW('Data adicionada'); }catch{ toastDW('Erro ao salvar','error'); }}
  function removeClosedDateDW(dateISO){ try{ let list=JSON.parse(localStorage.getItem('closedDates')||'[]'); list=list.filter(d=>d!==dateISO); localStorage.setItem('closedDates', JSON.stringify(list)); renderClosedDatesDW(); toastDW('Data removida'); }catch{ toastDW('Erro ao remover','error'); }}
  function toggleAllSundaysDW(){ try{ let closed=JSON.parse(localStorage.getItem('closedDates')||'[]'); const today=new Date(); const end=new Date(today); end.setMonth(end.getMonth()+12); const has=closed.some(dateISO=> new Date(dateISO+'T12:00:00').getDay()===0); if (has){ closed = closed.filter(dateISO=> new Date(dateISO+'T12:00:00').getDay()!==0); } else { let cur=new Date(today); cur.setDate(cur.getDate()+ ((7-cur.getDay())%7) ); while (cur<=end){ const iso = cur.toISOString().slice(0,10); if (!closed.includes(iso)) closed.push(iso); cur.setDate(cur.getDate()+7); } }
    closed.sort(); localStorage.setItem('closedDates', JSON.stringify(closed)); renderClosedDatesDW(); toastDW(has?'Domingos reabertos':'Domingos fechados'); }catch{ toastDW('Erro ao processar','error'); }}
  function toggleAllMondaysDW(){ try{ let closed=JSON.parse(localStorage.getItem('closedDates')||'[]'); const today=new Date(); const end=new Date(today); end.setMonth(end.getMonth()+12); const has=closed.some(dateISO=> new Date(dateISO+'T12:00:00').getDay()===1); if (has){ closed = closed.filter(dateISO=> new Date(dateISO+'T12:00:00').getDay()!==1); } else { let cur=new Date(today); const delta=(1 - cur.getDay() + 7)%7; cur.setDate(cur.getDate()+ (delta===0?7:delta)); while (cur<=end){ const iso = cur.toISOString().slice(0,10); if (!closed.includes(iso)) closed.push(iso); cur.setDate(cur.getDate()+7); } }
    closed.sort(); localStorage.setItem('closedDates', JSON.stringify(closed)); renderClosedDatesDW(); toastDW(has?'Segundas reabertas':'Segundas fechadas'); }catch{ toastDW('Erro ao processar','error'); }}

  // Segurança (senha admin)
  function changeAdminPasswordDW(){ const current=document.getElementById('currentAdminPasswordDW')?.value||''; const next=document.getElementById('newAdminPasswordDW')?.value||''; const confirm=document.getElementById('confirmAdminPasswordDW')?.value||''; if (current!==getAdminPassword()) { toastDW('Senha atual incorreta','error'); return; } if (!next || next.length<6){ toastDW('Nova senha deve ter 6+ caracteres','error'); return; } if (next!==confirm){ toastDW('Confirmação não confere','error'); return; } try{ localStorage.setItem('adminPassword', next); toastDW('Senha alterada com sucesso'); document.getElementById('currentAdminPasswordDW').value=''; document.getElementById('newAdminPasswordDW').value=''; document.getElementById('confirmAdminPasswordDW').value=''; }catch{ toastDW('Não foi possível salvar','error'); } }
  function resetAdminPasswordToDefaultDW(){ try{ localStorage.removeItem('adminPassword'); toastDW('Senha restaurada para o padrão'); }catch{} }

  // Data Cleanup
  function clearBookingsDW() {
    if (!confirm('⚠️ ATENÇÃO: Esta ação irá remover TODOS os agendamentos do sistema.\n\nBarbeiros e serviços permanecerão.\n\nDeseja continuar?')) {
      return;
    }
    
    if (!confirm('Confirme novamente: Deseja realmente limpar todos os agendamentos?')) {
      return;
    }
    
    try {
      localStorage.removeItem('bookings');
      toastDW('✅ Todos os agendamentos foram removidos', 'success');
      
      // Recarregar dados do dashboard
      setTimeout(() => {
        loadStats();
        loadRecent();
        renderMonthlyGoalChart();
        renderTopClientsChart();
      }, 500);
    } catch (error) {
      toastDW('Erro ao limpar agendamentos', 'error');
      console.error('Erro:', error);
    }
  }

  function clearAllDataDW() {
    if (!confirm('⛔ ATENÇÃO MÁXIMA: Esta ação irá remover TODOS os dados do sistema:\n\n• Agendamentos\n• Barbeiros\n• Serviços\n• Configurações\n• Horários disponíveis\n• Datas fechadas\n• Metas financeiras\n\nEsta ação NÃO pode ser desfeita!\n\nDeseja continuar?')) {
      return;
    }
    
    if (!confirm('CONFIRMAÇÃO FINAL: Digite "LIMPAR TUDO" para confirmar (caso contrário, clique em Cancelar)')) {
      return;
    }
    
    const confirmation = prompt('Digite exatamente "LIMPAR TUDO" para confirmar:');
    if (confirmation !== 'LIMPAR TUDO') {
      toastDW('Operação cancelada', 'info');
      return;
    }
    
    try {
      // Remover todos os dados do localStorage
      const keysToRemove = [
        'bookings',
        'barbers',
        'services',
        'closedDates',
        'availableSlots',
        'availableSlotsByDay',
        'financeGoals',
        'adminPassword'
      ];
      
      keysToRemove.forEach(key => localStorage.removeItem(key));
      
      toastDW('✅ Todos os dados foram removidos', 'success');
      
      // Recarregar a página após 2 segundos
      setTimeout(() => {
        window.location.reload();
      }, 2000);
    } catch (error) {
      toastDW('Erro ao limpar dados', 'error');
      console.error('Erro:', error);
    }
  }

  // Backup/Restore
  function exportBackupDW(){ try{ const data={ bookings: JSON.parse(localStorage.getItem('bookings')||'[]'), closedDates: JSON.parse(localStorage.getItem('closedDates')||'[]'), availableSlots: JSON.parse(localStorage.getItem('availableSlots')||'null'), availableSlotsByDay: JSON.parse(localStorage.getItem('availableSlotsByDay')||'null'), adminPassword: localStorage.getItem('adminPassword')||null, exportedAt: new Date().toISOString()}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); const dt=new Date(); const y=dt.getFullYear(); const m=String(dt.getMonth()+1).padStart(2,'0'); const d=String(dt.getDate()).padStart(2,'0'); a.href=url; a.download=`barbearia-backup-${y}${m}${d}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); toastDW('Backup exportado'); }catch{ toastDW('Falha ao exportar backup','error'); } }
  function importBackupDW(input){ const file=input?.files?.[0]; if (!file) return; const reader=new FileReader(); reader.onload=function(e){ try{ const json=JSON.parse(e.target.result); if (Array.isArray(json.bookings)) localStorage.setItem('bookings', JSON.stringify(json.bookings)); if (Array.isArray(json.closedDates)) localStorage.setItem('closedDates', JSON.stringify(json.closedDates)); if (json.availableSlots==null || Array.isArray(json.availableSlots)) { if (json.availableSlots==null) localStorage.removeItem('availableSlots'); else localStorage.setItem('availableSlots', JSON.stringify(json.availableSlots)); } if (json.availableSlotsByDay==null || typeof json.availableSlotsByDay==='object'){ if (json.availableSlotsByDay==null) localStorage.removeItem('availableSlotsByDay'); else localStorage.setItem('availableSlotsByDay', JSON.stringify(json.availableSlotsByDay)); } if (typeof json.adminPassword==='string' && json.adminPassword.length){ localStorage.setItem('adminPassword', json.adminPassword); }
      renderClosedDatesDW(); renderAvailableSlotsListDW(); renderWeeklyCalendarDW(); toastDW('Backup importado'); }catch{ toastDW('Arquivo inválido','error'); } finally { input.value=''; } }; reader.onerror=function(){ toastDW('Não foi possível ler o arquivo','error'); input.value=''; }; reader.readAsText(file); }

  // ==============
  // ==============
  // Finance Management
  // ==============
  let financeState = {
    period: 'month', // today, week, month, year
    chartType: 'weekly', // daily, weekly, monthly
    revenueChart: null,
    paymentChart: null,
    goals: {
      revenue: 10000,
      clients: 50,
      bookings: 100
    }
  };

  function loadFinanceViewDW() {
    console.log('[FINANCE] Carregando view financeira');
    loadFinanceGoalsFromStorage();
    calculateFinanceMetrics();
    renderRevenueChart();
    renderPaymentMethodsChart();
    renderTopServices();
  }

  function loadFinanceGoalsFromStorage() {
    try {
      const stored = localStorage.getItem('financeGoals');
      if (stored) {
        financeState.goals = JSON.parse(stored);
      }
    } catch(e) {
      console.error('[FINANCE] Erro ao carregar metas:', e);
    }
    // Atualizar UI com metas carregadas
    document.getElementById('goal-revenue-target').textContent = currencyBRL(financeState.goals.revenue);
    document.getElementById('goal-clients-target').textContent = financeState.goals.clients;
    document.getElementById('goal-bookings-target').textContent = financeState.goals.bookings;
  }

  function setFinancePeriod(period) {
    financeState.period = period;
    // Atualizar botões ativos
    ['today', 'week', 'month', 'year'].forEach(p => {
      const btn = document.getElementById(`finance-${p}`);
      if (btn) {
        if (p === period) {
          btn.classList.remove('bg-gray-700', 'text-gray-300');
          btn.classList.add('bg-emerald-600', 'text-white');
        } else {
          btn.classList.remove('bg-emerald-600', 'text-white');
          btn.classList.add('bg-gray-700', 'text-gray-300');
        }
      }
    });
    calculateFinanceMetrics();
  }

  function setRevenueChart(type) {
    financeState.chartType = type;
    // Atualizar botões ativos
    ['daily', 'weekly', 'monthly'].forEach(t => {
      const btn = document.getElementById(`chart-${t}`);
      if (btn) {
        if (t === type) {
          btn.classList.remove('bg-gray-700', 'text-gray-300');
          btn.classList.add('bg-emerald-600', 'text-white');
        } else {
          btn.classList.remove('bg-emerald-600', 'text-white');
          btn.classList.add('bg-gray-700', 'text-gray-300');
        }
      }
    });
    renderRevenueChart();
  }

  function calculateFinanceMetrics() {
    const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
    const now = new Date();
    let startDate, endDate = now;

    // Definir período
    switch(financeState.period) {
      case 'today':
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        break;
      case 'week':
        startDate = new Date(now);
        startDate.setDate(now.getDate() - 7);
        break;
      case 'month':
        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        break;
      case 'year':
        startDate = new Date(now.getFullYear(), 0, 1);
        break;
    }

    // Filtrar bookings do período
    const periodBookings = bookings.filter(b => {
      const bookingDate = new Date(b.dataISO || b.data);
      return bookingDate >= startDate && bookingDate <= endDate && b.status !== 'Cancelado';
    });

    // Calcular métricas
    const totalRevenue = periodBookings.reduce((sum, b) => sum + (parseFloat(b.valor) || 0), 0);
    const totalClients = new Set(periodBookings.map(b => b.telefone)).size;
    const totalBookings = periodBookings.length;
    const avgTicket = totalBookings > 0 ? totalRevenue / totalBookings : 0;

    // Calcular período anterior para comparação
    const prevStartDate = new Date(startDate);
    const prevEndDate = new Date(startDate);
    const periodDiff = endDate - startDate;
    prevStartDate.setTime(prevStartDate.getTime() - periodDiff);
    
    const prevBookings = bookings.filter(b => {
      const bookingDate = new Date(b.dataISO || b.data);
      return bookingDate >= prevStartDate && bookingDate < startDate && b.status !== 'Cancelado';
    });

    const prevRevenue = prevBookings.reduce((sum, b) => sum + (parseFloat(b.valor) || 0), 0);
    const prevClients = new Set(prevBookings.map(b => b.telefone)).size;
    const prevBookingsCount = prevBookings.length;
    const prevAvgTicket = prevBookingsCount > 0 ? prevRevenue / prevBookingsCount : 0;

    // Calcular variações percentuais
    const revenueChange = prevRevenue > 0 ? ((totalRevenue - prevRevenue) / prevRevenue * 100).toFixed(1) : 0;
    const clientsChange = prevClients > 0 ? ((totalClients - prevClients) / prevClients * 100).toFixed(1) : 0;
    const bookingsChange = prevBookingsCount > 0 ? ((totalBookings - prevBookingsCount) / prevBookingsCount * 100).toFixed(1) : 0;
    const ticketChange = prevAvgTicket > 0 ? ((avgTicket - prevAvgTicket) / prevAvgTicket * 100).toFixed(1) : 0;

    // Atualizar UI
    document.getElementById('finance-revenue').textContent = currencyBRL(totalRevenue);
    document.getElementById('finance-revenue-change').textContent = `${revenueChange >= 0 ? '+' : ''}${revenueChange}%`;
    document.getElementById('finance-revenue-change').className = revenueChange >= 0 ? 'text-emerald-500' : 'text-red-500';

    document.getElementById('finance-avg-ticket').textContent = currencyBRL(avgTicket);
    document.getElementById('finance-ticket-change').textContent = `${ticketChange >= 0 ? '+' : ''}${ticketChange}%`;
    document.getElementById('finance-ticket-change').className = ticketChange >= 0 ? 'text-blue-500' : 'text-red-500';

    document.getElementById('finance-clients').textContent = totalClients;
    document.getElementById('finance-clients-change').textContent = `${clientsChange >= 0 ? '+' : ''}${clientsChange}%`;
    document.getElementById('finance-clients-change').className = clientsChange >= 0 ? 'text-purple-500' : 'text-red-500';

    document.getElementById('finance-bookings').textContent = totalBookings;
    document.getElementById('finance-bookings-change').textContent = `${bookingsChange >= 0 ? '+' : ''}${bookingsChange}%`;
    document.getElementById('finance-bookings-change').className = bookingsChange >= 0 ? 'text-orange-500' : 'text-red-500';

    // Atualizar metas
    updateGoalsProgress(totalRevenue, totalClients, totalBookings);

    // Calcular projeções
    calculateProjections(totalRevenue, totalBookings, revenueChange);
  }

  function updateGoalsProgress(revenue, clients, bookings) {
    // Faturamento
    const revenuePercent = Math.min((revenue / financeState.goals.revenue * 100), 100).toFixed(0);
    document.getElementById('goal-revenue-current').textContent = currencyBRL(revenue);
    document.getElementById('goal-revenue-bar').style.width = `${revenuePercent}%`;
    document.getElementById('goal-revenue-percent').textContent = `${revenuePercent}%`;

    // Clientes
    const clientsPercent = Math.min((clients / financeState.goals.clients * 100), 100).toFixed(0);
    document.getElementById('goal-clients-current').textContent = clients;
    document.getElementById('goal-clients-bar').style.width = `${clientsPercent}%`;
    document.getElementById('goal-clients-percent').textContent = `${clientsPercent}%`;

    // Agendamentos
    const bookingsPercent = Math.min((bookings / financeState.goals.bookings * 100), 100).toFixed(0);
    document.getElementById('goal-bookings-current').textContent = bookings;
    document.getElementById('goal-bookings-bar').style.width = `${bookingsPercent}%`;
    document.getElementById('goal-bookings-percent').textContent = `${bookingsPercent}%`;
  }

  function calculateProjections(currentRevenue, currentBookings, growthRate) {
    const now = new Date();
    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    const daysPassed = now.getDate();
    const daysRemaining = daysInMonth - daysPassed;

    // Projeção mensal (baseada na média diária)
    const dailyAvg = daysPassed > 0 ? currentRevenue / daysPassed : 0;
    const monthProjection = currentRevenue + (dailyAvg * daysRemaining);
    document.getElementById('projection-month').textContent = currencyBRL(monthProjection);

    // Projeção trimestral
    const quarterProjection = monthProjection * 3;
    document.getElementById('projection-quarter').textContent = currencyBRL(quarterProjection);

    // Taxa de crescimento
    document.getElementById('growth-rate').textContent = `${growthRate >= 0 ? '+' : ''}${growthRate}%`;
    document.getElementById('growth-rate').className = growthRate >= 0 ? 'text-2xl font-bold text-emerald-400' : 'text-2xl font-bold text-red-400';
  }

  function renderRevenueChart() {
    const ctx = document.getElementById('revenueChartFinance');
    if (!ctx) return;

    const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
    let labels = [];
    let data = [];

    if (financeState.chartType === 'daily') {
      // Últimos 7 dias
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        labels.push(date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }));
        
        const dayBookings = bookings.filter(b => 
          (b.dataISO || b.data) === dateStr && b.status !== 'Cancelado'
        );
        const dayRevenue = dayBookings.reduce((sum, b) => sum + (parseFloat(b.valor) || 0), 0);
        data.push(dayRevenue);
      }
    } else if (financeState.chartType === 'weekly') {
      // Últimas 4 semanas
      for (let i = 3; i >= 0; i--) {
        const endDate = new Date();
        endDate.setDate(endDate.getDate() - (i * 7));
        const startDate = new Date(endDate);
        startDate.setDate(startDate.getDate() - 6);
        
        labels.push(`Sem ${4 - i}`);
        
        const weekBookings = bookings.filter(b => {
          const bookingDate = new Date(b.dataISO || b.data);
          return bookingDate >= startDate && bookingDate <= endDate && b.status !== 'Cancelado';
        });
        const weekRevenue = weekBookings.reduce((sum, b) => sum + (parseFloat(b.valor) || 0), 0);
        data.push(weekRevenue);
      }
    } else {
      // Últimos 6 meses
      for (let i = 5; i >= 0; i--) {
        const date = new Date();
        date.setMonth(date.getMonth() - i);
        labels.push(date.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' }));
        
        const monthBookings = bookings.filter(b => {
          const bookingDate = new Date(b.dataISO || b.data);
          return bookingDate.getMonth() === date.getMonth() && 
                 bookingDate.getFullYear() === date.getFullYear() && 
                 b.status !== 'Cancelado';
        });
        const monthRevenue = monthBookings.reduce((sum, b) => sum + (parseFloat(b.valor) || 0), 0);
        data.push(monthRevenue);
      }
    }

    if (financeState.revenueChart) {
      financeState.revenueChart.destroy();
    }

    financeState.revenueChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Faturamento',
          data: data,
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: 3,
          pointRadius: 4,
          pointBackgroundColor: '#10b981',
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (context) => `Faturamento: ${currencyBRL(context.parsed.y)}`
            }
          }
        },
        scales: {
          x: { 
            ticks: { color: '#9CA3AF' },
            grid: { color: 'rgba(255,255,255,0.05)' }
          },
          y: { 
            ticks: { 
              color: '#9CA3AF',
              callback: (value) => currencyBRL(value)
            },
            grid: { color: 'rgba(255,255,255,0.05)' }
          }
        }
      }
    });
  }

  function renderPaymentMethodsChart() {
    const ctx = document.getElementById('paymentMethodsChart');
    if (!ctx) return;

    const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
    const paidBookings = bookings.filter(b => b.status === 'Pago');

    // Simular métodos de pagamento (já que não temos esse campo nos dados)
    const methods = {
      'Dinheiro': Math.round(paidBookings.length * 0.3),
      'Pix': Math.round(paidBookings.length * 0.45),
      'Cartão': Math.round(paidBookings.length * 0.20),
      'Outros': Math.round(paidBookings.length * 0.05)
    };

    if (financeState.paymentChart) {
      financeState.paymentChart.destroy();
    }

    financeState.paymentChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(methods),
        datasets: [{
          data: Object.values(methods),
          backgroundColor: [
            'rgba(16, 185, 129, 0.8)',
            'rgba(59, 130, 246, 0.8)',
            'rgba(168, 85, 247, 0.8)',
            'rgba(251, 146, 60, 0.8)'
          ],
          borderColor: '#2A2A2A',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#9CA3AF', padding: 15, font: { size: 12 } }
          }
        }
      }
    });
  }

  function renderTopServices() {
    const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
    const paidBookings = bookings.filter(b => b.status === 'Pago');

    // Agrupar por serviço
    const serviceRevenue = {};
    paidBookings.forEach(b => {
      const service = b.servico || b.servicoNome || 'Sem serviço';
      const value = parseFloat(b.valor) || 0;
      serviceRevenue[service] = (serviceRevenue[service] || 0) + value;
    });

    // Ordenar e pegar top 5
    const topServices = Object.entries(serviceRevenue)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);

    const container = document.getElementById('top-services');
    if (!container) return;

    if (topServices.length === 0) {
      container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum serviço pago ainda</p>';
      return;
    }

    const maxRevenue = topServices[0][1];
    container.innerHTML = topServices.map(([ service, revenue], index) => {
      const percent = (revenue / maxRevenue * 100).toFixed(0);
      const colors = ['emerald', 'blue', 'purple', 'orange', 'pink'];
      const color = colors[index % colors.length];
      
      return `
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="flex justify-between mb-1">
              <span class="text-gray-300 text-sm">${service}</span>
              <span class="text-${color}-400 text-sm font-semibold">${currencyBRL(revenue)}</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2">
              <div class="bg-${color}-500 h-2 rounded-full transition-all duration-500" style="width: ${percent}%"></div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function openGoalsModal() {
    const modal = document.getElementById('goalsModalDW');
    if (!modal) return;

    // Preencher com valores atuais
    document.getElementById('goalRevenueInputDW').value = financeState.goals.revenue;
    document.getElementById('goalClientsInputDW').value = financeState.goals.clients;
    document.getElementById('goalBookingsInputDW').value = financeState.goals.bookings;

    // Mostrar modal
    modal.classList.remove('hidden');

    // Focus no primeiro campo
    setTimeout(() => {
      document.getElementById('goalRevenueInputDW').focus();
    }, 100);
  }

  function closeGoalsModalDW() {
    const modal = document.getElementById('goalsModalDW');
    if (modal) modal.classList.add('hidden');
  }

  // Fechar modal ao clicar fora ou ESC
  document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('goalsModalDW');
    if (modal) {
      // Clicar no backdrop (fundo escuro)
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeGoalsModalDW();
        }
      });
      
      // Tecla ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
          closeGoalsModalDW();
        }
      });

      // Enter nos inputs para salvar
      const inputs = modal.querySelectorAll('input');
      inputs.forEach(input => {
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            saveGoalsDW();
          }
        });
      });
    }
  });

  function saveGoalsDW() {
    const revenue = parseFloat(document.getElementById('goalRevenueInputDW').value);
    const clients = parseInt(document.getElementById('goalClientsInputDW').value);
    const bookings = parseInt(document.getElementById('goalBookingsInputDW').value);

    // Validações
    if (!revenue || revenue <= 0) {
      toastDW('Insira uma meta de faturamento válida', 'error');
      return;
    }

    if (!clients || clients <= 0) {
      toastDW('Insira uma meta de clientes válida', 'error');
      return;
    }

    if (!bookings || bookings <= 0) {
      toastDW('Insira uma meta de agendamentos válida', 'error');
      return;
    }

    // Atualizar estado
    financeState.goals.revenue = revenue;
    financeState.goals.clients = clients;
    financeState.goals.bookings = bookings;

    // Salvar no localStorage
    localStorage.setItem('financeGoals', JSON.stringify(financeState.goals));
    
    // Fechar modal
    closeGoalsModalDW();
    
    // Atualizar view
    loadFinanceViewDW();
    
    toastDW('Metas atualizadas com sucesso! 🎯');
  }

  // ==============
  // ==============
  // Services Management
  // ==============
  function loadServicesDW() {
    console.log('[SERVICES] Carregando serviços');
    renderServicesGridDW();
    // Anexar event handler DEPOIS de renderizar
    setTimeout(() => attachServicesGridHandler(), 100);
  }

  function getServicesDW() {
    try {
      const stored = localStorage.getItem('services');
      if (stored) {
        return JSON.parse(stored);
      }
    } catch(e) {
      console.error('[SERVICES] Erro ao ler localStorage:', e);
    }
    // Retorna serviços padrão se não houver nenhum e salva no localStorage
    const defaultServices = [
      { id: 1, name: 'Corte Geral', value: 40.00, duration: 45, description: 'Corte de cabelo tradicional' },
      { id: 2, name: 'Alinhamento de Cabelo', value: 40.00, duration: 30, description: 'Alinhamento e acabamento' },
      { id: 3, name: 'Combo Premium', value: 60.00, duration: 90, description: 'Corte + Barba completo' },
      { id: 4, name: 'Luzes', value: 110.00, duration: 120, description: 'Coloração e luzes' },
      { id: 5, name: 'Pesinho', value: 15.00, duration: 15, description: 'Acabamento rápido' },
      { id: 6, name: 'Barba', value: 30.00, duration: 30, description: 'Aparar e modelar a barba' }
    ];
    // Salva os serviços padrão no localStorage
    saveServicesToStorageDW(defaultServices);
    return defaultServices;
  }

  function saveServicesToStorageDW(services) {
    try {
      localStorage.setItem('services', JSON.stringify(services));
      console.log('[SERVICES] Salvos no localStorage:', services.length);
      
      // Disparar evento customizado para notificar outras abas/páginas
      window.dispatchEvent(new StorageEvent('storage', {
        key: 'services',
        newValue: JSON.stringify(services),
        url: window.location.href
      }));
      
      console.log('[SERVICES] Evento de sincronização disparado');
    } catch(e) {
      console.error('[SERVICES] Erro ao salvar:', e);
    }
  }

  function renderServicesGridDW() {
    const grid = document.getElementById('servicesGridDW');
    if (!grid) return;

    const services = getServicesDW();
    console.log('[SERVICES] Renderizando', services.length, 'serviços');

    if (services.length === 0) {
      grid.innerHTML = `
        <div class="col-span-full text-center py-12 text-gray-400">
          <p class="text-lg mb-2">Nenhum serviço cadastrado</p>
          <p class="text-sm">Clique em "Novo Serviço" para adicionar</p>
        </div>
      `;
      return;
    }

    grid.innerHTML = services.map(svc => `
      <div class="bg-[#2A2A2A] border border-gray-700 rounded-lg p-4 hover:border-[#00F5D4]/50 transition-colors">
        <div class="flex items-start justify-between mb-3">
          <div class="flex-1">
            <h4 class="text-lg font-semibold text-gray-100 mb-1">${svc.name}</h4>
            ${svc.description ? `<p class="text-sm text-gray-400 mb-2">${svc.description}</p>` : ''}
          </div>
        </div>
        <div class="flex items-center justify-between mb-3">
          <div class="text-2xl font-bold text-[#00F5D4]">
            R$ ${Number(svc.value).toFixed(2)}
          </div>
          <div class="text-sm text-gray-400">
            ⏱️ ${svc.duration} min
          </div>
        </div>
        <div class="flex gap-2">
          <button data-action="edit" data-service-id="${svc.id}" class="service-action-btn flex-1 px-3 py-2 rounded-md bg-gray-700 text-gray-200 hover:bg-gray-600 transition-colors text-sm">
            ✏️ Editar
          </button>
          <button data-action="delete" data-service-id="${svc.id}" class="service-action-btn px-3 py-2 rounded-md bg-red-600/20 text-red-400 hover:bg-red-600/30 transition-colors text-sm">
            🗑️
          </button>
        </div>
      </div>
    `).join('');
  }

  // Event delegation para serviços - anexa sempre que renderiza
  function attachServicesGridHandler() {
    const grid = document.getElementById('servicesGridDW');
    if (!grid) {
      console.log('[SERVICES] Grid não encontrado');
      return;
    }
    
    // Remove listeners antigos clonando o grid
    const newGrid = grid.cloneNode(true);
    grid.parentNode.replaceChild(newGrid, grid);
    
    // Anexa novo listener
    newGrid.addEventListener('click', (e) => {
      console.log('[SERVICE_ACTION] Clique detectado:', e.target);
      
      // Procura o botão mesmo se clicar no emoji ou em qualquer elemento filho
      const button = e.target.closest('.service-action-btn');
      if (!button) {
        console.log('[SERVICE_ACTION] Nenhum botão encontrado para o clique');
        return;
      }
      
      const action = button.getAttribute('data-action');
      const serviceId = parseInt(button.getAttribute('data-service-id'));
      
      console.log('[SERVICE_ACTION] Action:', action, 'ID:', serviceId);
      
      // Prevenir propagação do evento
      e.stopPropagation();
      e.preventDefault();
      
      if (action === 'edit') {
        editServiceDW(serviceId);
      } else if (action === 'delete') {
        deleteServiceDW(serviceId);
      }
    });
    
    console.log('[SERVICES] Event handler attached');
  }

  function openAddServiceModalDW() {
    const modal = document.getElementById('serviceModalDW');
    const title = document.getElementById('serviceModalTitleDW');
    const editId = document.getElementById('serviceEditIdDW');
    
    if (!modal) return;

    // Limpar formulário
    document.getElementById('serviceNameInputDW').value = '';
    document.getElementById('serviceValueInputDW').value = '';
    document.getElementById('serviceDurationInputDW').value = '';
    document.getElementById('serviceDescInputDW').value = '';
    editId.value = '';
    
    title.textContent = 'Novo Serviço';
    modal.classList.remove('hidden');
    
    // Bind Enter key to save
    const inputs = modal.querySelectorAll('input, textarea');
    inputs.forEach(input => {
      input.onkeypress = (e) => {
        if (e.key === 'Enter' && input.tagName !== 'TEXTAREA') {
          e.preventDefault();
          saveServiceDW();
        }
      };
    });
    
    setTimeout(() => {
      document.getElementById('serviceNameInputDW').focus();
    }, 100);
  }

  function editServiceDW(serviceId) {
    const services = getServicesDW();
    const service = services.find(s => s.id === serviceId);
    
    if (!service) {
      toastDW('Serviço não encontrado', 'error');
      return;
    }

    const modal = document.getElementById('serviceModalDW');
    const title = document.getElementById('serviceModalTitleDW');
    
    document.getElementById('serviceEditIdDW').value = serviceId;
    document.getElementById('serviceNameInputDW').value = service.name;
    document.getElementById('serviceValueInputDW').value = service.value;
    document.getElementById('serviceDurationInputDW').value = service.duration;
    document.getElementById('serviceDescInputDW').value = service.description || '';
    
    title.textContent = 'Editar Serviço';
    modal.classList.remove('hidden');
    
    // Bind Enter key to save
    const inputs = modal.querySelectorAll('input, textarea');
    inputs.forEach(input => {
      input.onkeypress = (e) => {
        if (e.key === 'Enter' && input.tagName !== 'TEXTAREA') {
          e.preventDefault();
          saveServiceDW();
        }
      };
    });
    
    setTimeout(() => {
      document.getElementById('serviceNameInputDW').focus();
    }, 100);
  }

  function closeServiceModalDW() {
    const modal = document.getElementById('serviceModalDW');
    if (modal) {
      modal.classList.add('hidden');
    }
  }

  function saveServiceDW() {
    const editId = document.getElementById('serviceEditIdDW').value;
    const name = document.getElementById('serviceNameInputDW').value.trim();
    const value = parseFloat(document.getElementById('serviceValueInputDW').value);
    const duration = parseInt(document.getElementById('serviceDurationInputDW').value);
    const description = document.getElementById('serviceDescInputDW').value.trim();

    // Validação
    if (!name) {
      toastDW('Nome do serviço é obrigatório', 'error');
      return;
    }
    if (!value || value <= 0) {
      toastDW('Valor deve ser maior que zero', 'error');
      return;
    }
    if (!duration || duration <= 0) {
      toastDW('Duração deve ser maior que zero', 'error');
      return;
    }

    let services = getServicesDW();

    if (editId) {
      // Editar serviço existente
      const index = services.findIndex(s => s.id === parseInt(editId));
      if (index !== -1) {
        services[index] = {
          ...services[index],
          name,
          value,
          duration,
          description
        };
        toastDW('Serviço atualizado');
      }
    } else {
      // Adicionar novo serviço
      const newId = services.length > 0 ? Math.max(...services.map(s => s.id)) + 1 : 1;
      services.push({
        id: newId,
        name,
        value,
        duration,
        description
      });
      toastDW('Serviço adicionado');
    }

    saveServicesToStorageDW(services);
    renderServicesGridDW();
    closeServiceModalDW();
  }

  function deleteServiceDW(serviceId) {
    if (!confirm('Tem certeza que deseja excluir este serviço?')) {
      return;
    }

    let services = getServicesDW();
    services = services.filter(s => s.id !== serviceId);
    
    saveServicesToStorageDW(services);
    renderServicesGridDW();
    toastDW('Serviço removido');
  }

  // ==============
  // ==============
  // Barbers Management
  // ==============
  function loadBarbersDW() {
    console.log('[BARBERS] Carregando barbeiros');
    renderBarbersGridDW();
    // Anexar event handler DEPOIS de renderizar
    setTimeout(() => attachBarbersGridHandler(), 100);
  }

  function getBarbersDW() {
    try {
      const stored = localStorage.getItem('barbers');
      if (stored) {
        return JSON.parse(stored);
      }
    } catch(e) {
      console.error('[BARBERS] Erro ao ler localStorage:', e);
    }
    // Retorna barbeiros padrão se não houver nenhum
    return [
      { 
        id: 1, 
        name: 'Carlos Silva', 
        phone: '(11) 98765-4321',
        email: 'carlos@barbershop.com',
        specialties: 'Cortes, Barba, Degradê',
        active: true
      },
      { 
        id: 2, 
        name: 'João Santos', 
        phone: '(11) 97654-3210',
        email: 'joao@barbershop.com',
        specialties: 'Cortes modernos, Pigmentação',
        active: true
      }
    ];
  }

  function saveBarbersToStorageDW(barbers) {
    try {
      localStorage.setItem('barbers', JSON.stringify(barbers));
      console.log('[BARBERS] Salvos no localStorage:', barbers.length);
      
      // Atualizar automaticamente o número de barbeiros ativos nas configurações
      const activeCount = barbers.filter(b => b.active).length;
      localStorage.setItem('active_barbers', activeCount.toString());
      console.log('[BARBERS] Barbeiros ativos:', activeCount);
    } catch(e) {
      console.error('[BARBERS] Erro ao salvar:', e);
    }
  }

  function renderBarbersGridDW() {
    const grid = document.getElementById('barbersGridDW');
    if (!grid) return;

    const barbers = getBarbersDW();
    console.log('[BARBERS] Renderizando', barbers.length, 'barbeiros');

    if (barbers.length === 0) {
      grid.innerHTML = `
        <div class="col-span-full text-center py-12 text-gray-400">
          <p class="text-lg mb-2">Nenhum barbeiro cadastrado</p>
          <p class="text-sm">Clique em "Novo Barbeiro" para adicionar</p>
        </div>
      `;
      return;
    }

    grid.innerHTML = barbers.map(barber => `
      <div class="bg-[#2A2A2A] border border-gray-700 rounded-lg p-5 hover:border-[#9D4EDD]/50 transition-colors relative">
        ${!barber.active ? '<div class="absolute top-3 right-3 px-2 py-1 bg-red-500/20 text-red-400 text-xs rounded">Inativo</div>' : '<div class="absolute top-3 right-3 px-2 py-1 bg-emerald-500/20 text-emerald-400 text-xs rounded">Ativo</div>'}
        
        <div class="flex items-start gap-4 mb-4">
          <div class="w-16 h-16 rounded-full bg-gradient-to-br from-[#9D4EDD] to-[#00F5D4] flex items-center justify-center text-2xl font-bold text-white">
            ${barber.name.charAt(0).toUpperCase()}
          </div>
          <div class="flex-1">
            <h4 class="text-lg font-semibold text-gray-100 mb-1">${barber.name}</h4>
            ${barber.specialties ? `<p class="text-sm text-[#9D4EDD] mb-2">✂️ ${barber.specialties}</p>` : ''}
          </div>
        </div>
        
        <div class="space-y-2 mb-4 text-sm text-gray-400">
          ${barber.phone ? `
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              <span>${barber.phone}</span>
            </div>
          ` : ''}
          ${barber.email ? `
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              <span>${barber.email}</span>
            </div>
          ` : ''}
        </div>
        
        <div class="flex gap-2">
          <button data-action="edit" data-barber-id="${barber.id}" class="barber-action-btn flex-1 px-3 py-2 rounded-md bg-gray-700 text-gray-200 hover:bg-gray-600 transition-colors text-sm">
            ✏️ Editar
          </button>
          <button data-action="toggle" data-barber-id="${barber.id}" class="barber-action-btn px-3 py-2 rounded-md ${barber.active ? 'bg-yellow-600/20 text-yellow-400 hover:bg-yellow-600/30' : 'bg-emerald-600/20 text-emerald-400 hover:bg-emerald-600/30'} transition-colors text-sm">
            ${barber.active ? '⏸️' : '▶️'}
          </button>
          <button data-action="delete" data-barber-id="${barber.id}" class="barber-action-btn px-3 py-2 rounded-md bg-red-600/20 text-red-400 hover:bg-red-600/30 transition-colors text-sm">
            🗑️
          </button>
        </div>
      </div>
    `).join('');
  }

  // Event delegation para barbeiros - anexa sempre que renderiza
  function attachBarbersGridHandler() {
    const grid = document.getElementById('barbersGridDW');
    if (!grid) {
      console.log('[BARBERS] Grid não encontrado');
      return;
    }
    
    // Remove listeners antigos clonando o grid
    const newGrid = grid.cloneNode(true);
    grid.parentNode.replaceChild(newGrid, grid);
    
    // Anexa novo listener
    newGrid.addEventListener('click', (e) => {
      console.log('[BARBER_ACTION] Clique detectado:', e.target);
      
      // Procura o botão mesmo se clicar no emoji ou em qualquer elemento filho
      const button = e.target.closest('.barber-action-btn');
      if (!button) {
        console.log('[BARBER_ACTION] Nenhum botão encontrado para o clique');
        return;
      }
      
      const action = button.getAttribute('data-action');
      const barberId = parseInt(button.getAttribute('data-barber-id'));
      
      console.log('[BARBER_ACTION] Action:', action, 'ID:', barberId);
      
      // Prevenir propagação do evento
      e.stopPropagation();
      e.preventDefault();
      
      if (action === 'edit') {
        editBarberDW(barberId);
      } else if (action === 'toggle') {
        toggleBarberStatusDW(barberId);
      } else if (action === 'delete') {
        deleteBarberDW(barberId);
      }
    });
    
    console.log('[BARBERS] Event handler attached');
  }

  function openAddBarberModalDW() {
    const modal = document.getElementById('barberModalDW');
    const title = document.getElementById('barberModalTitleDW');
    const editId = document.getElementById('barberEditIdDW');
    
    if (!modal) return;

    // Limpar formulário
    document.getElementById('barberNameInputDW').value = '';
    document.getElementById('barberPhoneInputDW').value = '';
    document.getElementById('barberEmailInputDW').value = '';
    document.getElementById('barberSpecialtiesInputDW').value = '';
    document.getElementById('barberActiveInputDW').checked = true;
    editId.value = '';
    
    title.textContent = 'Novo Barbeiro';
    modal.classList.remove('hidden');
    
    // Bind Enter key to save
    const inputs = modal.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"]');
    inputs.forEach(input => {
      input.onkeypress = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveBarberDW();
        }
      };
    });
    
    setTimeout(() => {
      document.getElementById('barberNameInputDW').focus();
    }, 100);
  }

  function editBarberDW(barberId) {
    const barbers = getBarbersDW();
    const barber = barbers.find(b => b.id === barberId);
    
    if (!barber) {
      toastDW('Barbeiro não encontrado', 'error');
      return;
    }

    const modal = document.getElementById('barberModalDW');
    const title = document.getElementById('barberModalTitleDW');
    
    document.getElementById('barberEditIdDW').value = barberId;
    document.getElementById('barberNameInputDW').value = barber.name;
    document.getElementById('barberPhoneInputDW').value = barber.phone || '';
    document.getElementById('barberEmailInputDW').value = barber.email || '';
    document.getElementById('barberSpecialtiesInputDW').value = barber.specialties || '';
    document.getElementById('barberActiveInputDW').checked = barber.active !== false;
    
    title.textContent = 'Editar Barbeiro';
    modal.classList.remove('hidden');
    
    // Bind Enter key to save
    const inputs = modal.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"]');
    inputs.forEach(input => {
      input.onkeypress = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveBarberDW();
        }
      };
    });
    
    setTimeout(() => {
      document.getElementById('barberNameInputDW').focus();
    }, 100);
  }

  function closeBarberModalDW() {
    const modal = document.getElementById('barberModalDW');
    if (modal) {
      modal.classList.add('hidden');
    }
  }

  function saveBarberDW() {
    const editId = document.getElementById('barberEditIdDW').value;
    const name = document.getElementById('barberNameInputDW').value.trim();
    const phone = document.getElementById('barberPhoneInputDW').value.trim();
    const email = document.getElementById('barberEmailInputDW').value.trim();
    const specialties = document.getElementById('barberSpecialtiesInputDW').value.trim();
    const active = document.getElementById('barberActiveInputDW').checked;

    // Validação
    if (!name) {
      toastDW('Nome do barbeiro é obrigatório', 'error');
      return;
    }

    let barbers = getBarbersDW();

    if (editId) {
      // Editar barbeiro existente
      const index = barbers.findIndex(b => b.id === parseInt(editId));
      if (index !== -1) {
        barbers[index] = {
          ...barbers[index],
          name,
          phone,
          email,
          specialties,
          active
        };
        toastDW('Barbeiro atualizado');
      }
    } else {
      // Adicionar novo barbeiro
      const newId = barbers.length > 0 ? Math.max(...barbers.map(b => b.id)) + 1 : 1;
      barbers.push({
        id: newId,
        name,
        phone,
        email,
        specialties,
        active
      });
      toastDW('Barbeiro adicionado');
    }

    saveBarbersToStorageDW(barbers);
    renderBarbersGridDW();
    closeBarberModalDW();
    
    // Atualizar o campo de barbeiros ativos na view de settings
    const activeInput = document.getElementById('activeBarbersInputDW');
    if (activeInput) {
      const activeCount = barbers.filter(b => b.active).length;
      activeInput.value = activeCount;
    }
  }

  function toggleBarberStatusDW(barberId) {
    let barbers = getBarbersDW();
    const index = barbers.findIndex(b => b.id === barberId);
    
    if (index !== -1) {
      barbers[index].active = !barbers[index].active;
      const status = barbers[index].active ? 'ativado' : 'desativado';
      saveBarbersToStorageDW(barbers);
      renderBarbersGridDW();
      toastDW(`Barbeiro ${status}`);
      
      // Atualizar o campo de barbeiros ativos na view de settings
      const activeInput = document.getElementById('activeBarbersInputDW');
      if (activeInput) {
        const activeCount = barbers.filter(b => b.active).length;
        activeInput.value = activeCount;
      }
    }
  }

  function deleteBarberDW(barberId) {
    console.log('[DELETE_BARBER] Iniciando exclusão, ID:', barberId);
    
    const barbers = getBarbersDW();
    console.log('[DELETE_BARBER] Barbeiros atuais:', barbers);
    
    const barber = barbers.find(b => b.id === barberId);
    console.log('[DELETE_BARBER] Barbeiro encontrado:', barber);
    
    if (!confirm(`Tem certeza que deseja excluir ${barber?.name || 'este barbeiro'}?`)) {
      console.log('[DELETE_BARBER] Exclusão cancelada pelo usuário');
      return;
    }

    const updatedBarbers = barbers.filter(b => b.id !== barberId);
    console.log('[DELETE_BARBER] Barbeiros após filtro:', updatedBarbers);
    
    saveBarbersToStorageDW(updatedBarbers);
    renderBarbersGridDW();
    toastDW('Barbeiro removido');
    
    // Atualizar o campo de barbeiros ativos na view de settings
    const activeInput = document.getElementById('activeBarbersInputDW');
    if (activeInput) {
      const activeCount = updatedBarbers.filter(b => b.active).length;
      activeInput.value = activeCount;
    }
    
    console.log('[DELETE_BARBER] Exclusão concluída');
  }

  // Toast helper
  function toastDW(msg,type){
    const el=document.createElement('div');
    el.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-md shadow-lg ${type==='error'?'bg-red-600':'bg-emerald-600'} text-white text-sm`;
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(()=>{ el.remove(); }, 2500);
  }

  // Bind nav after DOM ready
  document.addEventListener('DOMContentLoaded', bindNavDW);

  // Safety: se nada estiver visível após 1s, força exibição do dashboard
  setTimeout(() => {
    try {
      const overlay = document.getElementById('loginOverlay');
      const main = document.getElementById('dashboardMain');
      const overlayVisible = overlay ? getComputedStyle(overlay).display !== 'none' : false;
      const mainVisible = main ? getComputedStyle(main).display !== 'none' : false;
      if (!overlayVisible && !mainVisible) {
        console.warn('[SAFETY] Nenhuma view visível; forçando dashboard');
        if (overlay) { overlay.classList.add('hidden'); overlay.style.display = 'none'; }
        if (main) { main.style.display = 'flex'; }
      }
    } catch (e) { console.warn('[SAFETY] Falha ao aplicar verificação de visibilidade', e); }
  }, 1000);

  // ====== HACKER LOGIN EFFECTS ======
  // Typewriter Effect
  function initTypewriter() {
    const typewriterElements = document.querySelectorAll('.typewriter-label');
    typewriterElements.forEach(element => {
      const text = element.getAttribute('data-text');
      if (!text) return;
      element.textContent = '';
      let i = 0;
      const speed = 100;
      
      function type() {
        if (i < text.length) {
          element.textContent += text.charAt(i);
          i++;
          setTimeout(type, speed);
        } else {
          element.classList.add('finished-typing');
        }
      }
      
      setTimeout(type, 300);
    });
  }

  // Matrix Rain Effect
  function createMatrixRain() {
    const matrixBg = document.getElementById('matrixBg');
    if (!matrixBg) return;
    
    const chars = '01アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン';
    const columns = Math.floor(window.innerWidth / 20);
    
    for (let i = 0; i < columns; i++) {
      const char = document.createElement('div');
      char.className = 'matrix-char';
      char.textContent = chars.charAt(Math.floor(Math.random() * chars.length));
      char.style.left = `${i * 20}px`;
      char.style.animationDuration = `${Math.random() * 3 + 2}s`;
      char.style.animationDelay = `${Math.random() * 2}s`;
      matrixBg.appendChild(char);
    }
  }

  // Initialize effects when login overlay is shown
  function showLogin() {
    const overlay = document.getElementById('loginOverlay');
    const main = document.getElementById('dashboardMain');
    console.log('[SHOWLOGIN] Mostrando overlay de login');
    if (overlay) {
      overlay.classList.remove('hidden');
      overlay.style.display = 'flex';
      
      // Initialize hacker effects
      setTimeout(() => {
        initTypewriter();
        createMatrixRain();
      }, 100);
    }
    if (main) {
      main.style.display = 'none';
    }
    // Focus e Enter
    const inp = document.getElementById('adminPwd');
    if (inp) {
      setTimeout(() => inp.focus(), 300);
      if (!inp._boundEnter) {
        inp._boundEnter = true;
        inp.addEventListener('keypress', (e) => { if (e.key === 'Enter') validateLogin(); });
      }
    }
  }
</script>
</body>
</html>
